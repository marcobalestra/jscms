(()=>{let ti={html:"index",editable:!0,repository:"searchtags",display:"Search by tag",service:!0,content:[{selector:"#aboveTopBar",content:!1},{selector:"#topBar",part:"header.json"},{selector:"#belowTopBar",content:!1},{selector:"#topNavbar",part:"navbar.json"},{selector:"#mainContainer",content:[{type:"blocks",editable:!0,blocks:[{type:"text",wrap:"<h3></h3>",prop:"title"},{type:"text",wrap:'<h6 class="jcAbstract"></h6>',prop:"abstract"},{type:"mixed",prop:"blocks"},{type:"searchbytag",prop:"sbytag",editable:!1},{type:"mixed",prop:"blocks2"}]},{type:"part",content:"sharethis.json"}]},{selector:"#topFooter",type:"text",content:"{{label:GlobalFooter}}"}]};jc.render.block.searchbytag=(b,d)=>{AS.test.udef(d[b.prop])&&(d[b.prop]={});let swalalert;const prog=options=>{if(!swalalert)return swalalert=Swal.fire({toast:!0,title:'<div class="jcProgressbar"></div>',html:" ",position:"top-end",showConfirmButton:!1}),setTimeout(()=>{prog(options)},10);let newopts={};options.close?setTimeout(()=>{Swal.close(),swalalert._destroy(),swalalert=!1},100):(options.text&&(newopts.html=`${options.text}`),options.prog&&(newopts.title=`<div class="jcProgressbar"><div style="width:${100*options.prog}%;"></div></div>`),swalalert.update(newopts))},$div=$('<div class="jcTagsSearch" id="'+AS.generateId("tagssearch")+'"></div>'),$panes=$('<div class="jcTagsSearchPars container" id="'+AS.generateId("tagssearchpars")+'"></div>'),$tgt=$('<div class="jcTagsFound" id="'+AS.generateId("tagsfound")+'"></div>').css("min-height","200px");$div.append($panes,$tgt);let all,ttags,tdata,totsteps;const load=cb=>{if(!jc.prop.site)return setTimeout(()=>{load(cb)},100);if(tdata||(tdata={},ttags=AS.def.arr(jc.prop.site.tags).map(x=>x.name),totsteps=1+ttags.length),!all)return prog({text:AS.label("Loading")+"…",prog:0}),void jc.lists.list.get(l=>{all=[],Object.keys(l).forEach(pt=>{Object.keys(l[pt]).forEach(id=>{all.push(l[pt][id])})}),load(cb)});if(ttags.length){let nt=ttags.shift();return prog({prog:(1+Object.keys(tdata).length)/totsteps}),void jc.lists.tag.get(nt,tt=>{tdata[nt]=tt,load(cb)})}if(totsteps)return prog({prog:(1+Object.keys(tdata).length)/totsteps}),void makeform(()=>{totsteps=0,load(cb)});prog({close:!0}),AS.test.func(cb)&&cb.call(window)},makeform=cb=>{if(all){var tid=AS.generateId("tag");$('<div class="row"></div>');let $sel=$(`<input type="text" name="filter" id="${tid}fld" value="" style="width:100%"/>`),$cb=$('<input type="checkbox" class="mr-2"/>').attr("id",tid).on("click",()=>{var t=$cb.is(":checked");$sel.closest("div").toggle(t),$sel.toggleClass("active",t),t&&$sel.focus()});$panes.append($('<div class="row"></div>').append($('<div class="col-lg-4"></div>').append($cb,`<label for="${tid}">${AS.label("Filter")}</label>`),$('<div class="col-lg-8" style="display:none;"></div>').append($sel)))}AS.def.arr(jc.prop.site.tags).forEach(to=>{let keys=Object.keys(tdata[to.name]);if(keys.length){var tid=AS.generateId("tag");$('<div class="row"></div>');let $sel=$(`<select name="${to.name}" id="${tid}sel" multiple="multiple"></select>`),$cb=$('<input type="checkbox" class="mr-2"/>').attr("id",tid).on("click",()=>{var t=$cb.is(":checked");$sel.closest("div").toggle(t),$sel.toggleClass("active",t),t&&$sel.focus()});keys.forEach(k=>{$sel.append(`<option>${k}</option>`)}),$panes.append($('<div class="row"></div>').append($('<div class="col-lg-4"></div>').append($cb,`<label for="${tid}">${to.label||to.name}</label>`),$('<div class="col-lg-8" style="display:none;"></div>').append($sel))),$sel.select2({width:"100%"})}}),$('input[type="checkbox"]',$panes).on("change",makesearch),$('input[name="filter"]',$panes).on("keyup",makesearch),$('input[name="filter"],select',$panes).on("change",makesearch),AS.test.func(cb)&&cb.call(window)},makesearch=cb=>{let filter=$('input.active[name="filter"]',$panes).val();if(filter=!!filter&&filter.toLowerCase(),!filter){let qt=0;if($("select.active",$panes).each((idx,s)=>{qt+=$(s).select2("data").length}),!qt)return void $tgt.html("")}let found=all.clone().filter(p=>!filter||((p,t)=>!!(p.title&&0<=p.title.toLowerCase().indexOf(t))||(!!(p.description&&0<=p.description.toLowerCase().indexOf(t))||!!(p.keywords&&0<=p.keywords.toLowerCase().indexOf(t))))(p,filter));$("select.active",$panes).each((idx,s)=>{let $s=$(s),keys=$s.select2("data").map(x=>x.id);if(keys.length){let tn=$s.attr("name");keys.forEach(k=>{found=found.filter(p=>tdata[tn]&&tdata[tn][k]&&tdata[tn][k].length&&tdata[tn][k].find(te=>te.type==p.type&&te.id==p.id))})}});let $ul=$('<ul class="jcEntries"></ul>');$tgt.html($ul.append("<hr/>")),found.sort((a,b)=>(a,b)=>a.title.toLowerCase()>b.title.toLowerCase()?1:-1).forEach(f=>{let $li=$('<li class="jcEntry"></li>').append($('<a class="title click"></a>').append(f.title).on("click",()=>{jc.page.open(f.type,f.id)}),$('<span class="date"></span>').html(new Date(f.upd).toLocaleDateString()));f.description&&f.description.length&&$li.append("<br />",$('<small class="desc"></small>').html(f.description)),$ul.append($li)}),AS.test.func(cb)&&cb.call(window)};return jc.render.queue(1),load(()=>{jc.render.queue(-1)}),$div},jc.template.info.set("searchtags",ti)})();