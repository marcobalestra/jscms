$.extend(jc.dav,{put:(url,data,success,fail,progf)=>{fail=jc.evalFunc(fail)||jc.evalFunc(success)||jc.getError,success=jc.evalFunc(success)||(()=>{}),url.match(jc.prop.absUriMatcher)||(url=AS.path("jsdataroot")+url),jc.console("jc.dav.put",url,data);let progress=data instanceof DataView&&65536<data.byteLength;$.ajax(url,{xhr:()=>{let xhr=$.ajaxSettings.xhr();return progress&&(xhr.upload.onprogress=e=>{e.lengthComputable&&(AS.test.func(progf)?progf.call(window,e.loaded,e.total,e.loaded/e.total):jc.progress("Upload: "+parseInt(100*e.loaded/e.total)+"%"))}),xhr},method:"PUT",dataType:"text",processData:!1,cache:!1,contentType:"text/plain; charset=UTF-8",data:data,error:(...errs)=>{progress&&(AS.test.func(progf)?progf.call(window,!1):jc.progress()),fail.call(window,!1,errs)},success:()=>{progress&&(AS.test.func(progf)?progf.call(window,!0):jc.progress()),success.call(window,!0)}})},mkdir:(url,success,fail)=>{fail=jc.evalFunc(fail)||jc.evalFunc(success)||jc.getError,success=jc.evalFunc(success)||(()=>{}),url.match(jc.prop.absUriMatcher)||(url=AS.path("jsdataroot")+url),jc.console("jc.dav.mkdir",url),$.ajax(url,{method:"MKCOL",cache:!1,dataType:"text",error:(...errs)=>{fail.call(window,!1,errs)},success:()=>{success.call(window,!0)}})},rm:(url,success,fail)=>{fail=fail||success||jc.getError,success=success||(()=>{}),url.match(jc.prop.absUriMatcher)||(url=AS.path("jsdataroot")+url),jc.console("jc.dav.rm",url),$.ajax(url,{method:"DELETE",cache:!1,contentType:"text/xml; charset=UTF-8",dataType:"text",error:(...errs)=>{fail.call(window,!1,errs)},success:xt=>{success.call(window,xt)}})},purge:(...args)=>{let success,fail,options={};args.forEach(a=>{if(AS.test.obj(a))return a.dir&&(options.dir=a.dir),a.ext&&(options.ext=a.ext),void(a.match&&(options.match=a.match));var f=jc.evalFunc(a);AS.test.func(f)&&(success?fail=f:success=f),AS.test.str(a)&&(options.dir=a)}),fail=fail||success||jc.getError,success=success||(()=>{}),options.dir&&(options.dir=options.dir.replace(/\/$/,"")),jc.dav.ls(options,out=>{let count=0,proc=()=>{var url;out.list.length?(count++,url=(out.dir?out.dir+"/":"")+out.list.shift(),jc.dav.rm(url,proc)):AS.test.func(success)&&success.call(window,count)};proc()},fail)},ls:(...url)=>{let success,fail,options={};url.forEach(a=>{if(AS.test.obj(a))return a.dir&&(options.dir=a.dir),a.ext&&(options.ext=a.ext),void(a.match&&(options.match=a.match));var f=jc.evalFunc(a);AS.test.func(f)&&(success?fail=f:success=f),AS.test.str(a)&&(options.dir=a)}),fail=fail||success||jc.getError,success=success||(()=>{});url=AS.path("jsauth")+"auth/lsdata";jc.console("jc.dav.ls",url),$.ajax(url,{method:"GET",cache:!1,dataType:"json",data:options,error:(...errs)=>{fail.call(window,!1,errs)},success:data=>{Object.keys(options).forEach(k=>{options[k]&&(data[k]=options[k])}),success.call(window,data)}})}}),$.extend(jc.jdav,{put:(url,data,success,fail)=>{fail=jc.evalFunc(fail)||jc.evalFunc(success)||jc.getError,success=jc.evalFunc(success)||(()=>{}),url.match(jc.prop.absUriMatcher)||(url=AS.path("jsdataroot")+url),jc.console("jc.jdav.put",url,data),$.ajax(url,{method:"PUT",cache:!1,dataType:"json",contentType:"application/json; charset=UTF-8",data:AS.test.obj(data)?JSON.stringify(data):data,error:(...errs)=>{fail.call(window,!1,errs)},success:()=>{success.call(window,!0)}})}}),Object.keys(jc.dav).forEach(k=>{AS.test.udef(jc.jdav[k])&&(jc.jdav[k]=jc.dav[k])}),$.extend(!0,jc.lists,{list:{set:(...args)=>{jc.plugin.call("listSetPre",args);let commit=args.find(a=>AS.test.bool(a));if(AS.test.udef(commit)&&(commit=!0),commit)jc.lists.list.commit.apply(window,args);else{var type=args.find(a=>AS.test.str(a))||"_all",list=JSON.parse(JSON.stringify(args.find(a=>AS.test.obj(a))||{}));const callback=args.find(a=>AS.test.func(a));jc.lists.prop.lists[type]=list,AS.test.func(callback)&&callback.call(window)}},commit:(...args)=>{jc.plugin.call("listCommitPre",args);const type=args.find(a=>AS.test.str(a))||"_all",list=JSON.parse(JSON.stringify(args.find(a=>AS.test.obj(a))||jc.lists.prop.lists[type]||{})),callback=args.find(a=>AS.test.func(a));jc.jdav.put(jc.lists.list.uri(type),list,r=>{jc.lists.prop.lists[type]=list,AS.test.func(callback)&&callback.call(window,r)})},dositemap:(...args)=>{const callback=args.find(a=>AS.test.func(a));let list=args.find(a=>AS.test.arr(a));if(list){var uri=jc.lists.list.uri().replace(/\/[^\/]+$/,"/sitemap.txt");let baseuri=window.location.protocol+"//"+window.location.hostname+"/",txt=baseuri+"\n";baseuri+="!",list.filter(x=>!x.hidden).forEach(i=>{i.hidden||(txt+=baseuri+i.type+(i.id||"")+(i.url?"/"+i.url:"")+"\n")}),jc.dav.put(uri,txt,r=>{AS.test.func(callback)&&callback.call(window,r)})}else jc.lists.list.get(l=>{let lst=[];Object.keys(l).forEach(pt=>{Object.keys(l[pt]).forEach(id=>{lst.push(l[pt][id])})}),args.push(lst),jc.lists.list.dositemap.apply(window,args)})}},last:{set:(...args)=>{let commit=args.find(a=>AS.test.bool(a));if(AS.test.udef(commit)&&(commit=!0),commit)jc.lists.last.commit.apply(window,args);else{var type=args.find(a=>AS.test.str(a))||"_all",qt=args.find(a=>AS.test.num(a)),list=JSON.parse(JSON.stringify(args.find(a=>AS.test.arr(a))||[]));const callback=args.find(a=>AS.test.func(a));jc.lists.prop.lasts[type]||(jc.lists.prop.lasts[type]={}),jc.lists.prop.lasts[type][String(qt)]=list,AS.test.func(callback)&&callback.call(window)}},commit:(...uri)=>{const type=uri.find(a=>AS.test.str(a))||"_all",qt=uri.find(a=>AS.test.num(a));let list=JSON.parse(JSON.stringify(uri.find(a=>AS.test.arr(a))||jc.lists.prop.lasts[type][String(qt)]||[]));const callback=uri.find(a=>AS.test.func(a));uri=jc.lists.last.uri(type,qt);jc.jdav.put(uri,list,r=>{jc.lists.prop.lasts[type]||(jc.lists.prop.lasts[type]={}),jc.lists.prop.lasts[type][String(qt)]=list,AS.test.func(callback)&&callback.call(window,r)})},dorss:(...args)=>{const type=args.find(a=>AS.test.str(a))||"_all";var uri=args.find(a=>AS.test.num(a));let list=args.find(a=>AS.test.arr(a));const callback=args.find(a=>AS.test.func(a));list=list||(jc.lists.prop.lasts[type][String(uri)]||[]);uri=jc.lists.last.uri(type,uri).replace(/\.json/,".rss");let feed='<?xml version="1.0" encoding="UTF-8" ?>\n<rss version="2.0">\n<channel>\n';feed+="<title>"+jc.prop.site.sitename.escape()+"</title>\n",feed+="<description>"+(jc.prop.site.headertag||jc.prop.site.sitename).escape()+"</description>\n";let baseuri=window.location.protocol+"//"+window.location.hostname+"/";feed+="<link>"+baseuri+"</link>\n",feed+="<generator>jBloud CMS - jscms</generator>\n",list.filter(x=>!x.hidden).forEach(i=>{var pt;i.hidden||(pt=i.page||i.type||type,feed+="<item>\n",feed+="\t<link>"+baseuri+"!"+pt+(i.id||"")+(i.url?"/"+i.url:"")+"</link>\n",feed+="\t<pubDate>"+new Date(i.upd).toUTCString()+"</pubDate>\n",feed+="\t<title>"+i.title.escape()+"</title>\n",feed+="\t<description><![CDATA["+(i.description||i.title)+"]]></description>\n",feed+="</item>\n")}),feed+="</channel>\n</rss>\n",jc.dav.put(uri,feed,r=>{AS.test.func(callback)&&callback.call(window,r)})}},tag:{set:(...args)=>{let commit=args.find(a=>AS.test.bool(a));if(AS.test.udef(commit)&&(commit=!0),commit)jc.lists.tag.commit.apply(window,args);else{var type=args.find(a=>AS.test.str(a))||"site",list=JSON.parse(JSON.stringify(args.find(a=>AS.test.arr(a))||{}));const callback=args.find(a=>AS.test.func(a));jc.lists.prop.tags[type]=list,AS.test.func(callback)&&callback.call(window)}},commit:(...args)=>{const type=args.find(a=>AS.test.str(a))||"site",list=JSON.parse(JSON.stringify(args.find(a=>AS.test.obj(a))||jc.lists.prop.tags[type]||{})),callback=args.find(a=>AS.test.func(a));jc.jdav.put(jc.lists.tag.uri(type),list,r=>{jc.lists.prop.tags[type]=list,AS.test.func(callback)&&callback.call(window,r)})}}}),jc.page.create=options=>{if(options=AS.def.obj(options),AS.test.udef(options.page)){let opts={};if(jc.prop.site.models&&jc.prop.site.models.length){let t={};jc.prop.site.models.forEach((k,idx)=>{t["model."+idx]=k.title+" ["+k.type+"]"}),opts[AS.label("Models")]=t}let e={};jc.edit.prop.pageTypes.filter(k=>!jc.edit.prop.pageTypesInfo[k].service).forEach(k=>{e[k]=jc.edit.prop.pageTypesInfo[k].display+" ["+k+"]"});let s={};return jc.edit.prop.pageTypes.filter(k=>jc.edit.prop.pageTypesInfo[k].service).forEach(k=>{s[k]=jc.edit.prop.pageTypesInfo[k].display}),opts[AS.label("Empty pages")]=e,opts[AS.label("Special")]=s,void Swal.fire({title:AS.label("SelectPageType"),text:AS.label("SelectPageTypeDesc"),input:"select",icon:"question",inputOptions:opts,inputPlaceholder:"Select",showCancelButton:!0,cancelButtonText:AS.label("Cancel"),confirmButtonText:AS.label("OK"),inputValidator:v=>new Promise(resolve=>{v.length?resolve():resolve(AS.label("SelectPageType"))})}).then(result=>{if(result.isConfirmed){let v=result.value;var t;console.log(v),0==v.indexOf("model.")?(t=jc.prop.site.models[parseInt(v.replace(/[^0-9]/g,""))],console.log(t),options.page=t.type,jc.jdav.get(AS.path("jsdatapages")+t.type+(t.id||"")+".json",d=>{options.predata=d,jc.page.create(options)})):(options.page=result.value,jc.page.create(options))}})}if(AS.test.udef(options.template))jc.template.info.get(options.page,tdata=>{options.template=tdata,jc.page.create(options)});else{if(AS.test.udef(options.data))return options.id="new",void jc.edit.meta.edit({pageData:{},editData:{metadata:{type:options.page,id:"new"}},callback:pd=>{options.predata&&(Object.keys(options.predata).forEach(k=>{AS.test.udef(pd[k])&&(pd[k]=options.predata[k])}),delete options.predata),options.data=pd,jc.page.create(options)}});if(options.noDialog=!0,options.noLasts=!0,AS.test.obj(options.template.content)){let blocks=[];options.template.content.forEach(c=>{AS.test.arr(c.content)?c.content.forEach(d=>{AS.test.arr(d.blocks)&&d.blocks.forEach(b=>{AS.test.obj(b)&&blocks.push(b)})}):AS.test.obj(c.content)&&AS.test.arr(c.content.blocks)&&c.content.blocks.forEach(b=>{AS.test.obj(b)&&blocks.push(b)})}),blocks.length&&(options.data.metadata.title&&blocks.find(b=>"title"==b.prop)&&(options.data.title=options.data.metadata.title),options.data.metadata.description&&(blocks.find(b=>"abstract"==b.prop)?options.data.abstract=options.data.metadata.description:blocks.find(b=>"descriptions"==b.prop)&&(options.data.descriptions=options.data.metadata.description)))}options.callback=(page,id,data)=>{jc.page.prop.editMode="page",jc.page.open(page,id)},jc.page.save(options)}},jc.page.rm=params=>{if(AS.test.udef(params)?params={}:AS.test.func(params)&&(params={callback:params}),AS.test.udef(params.page)&&(params.page=jc.page.current()),AS.test.udef(params.id)&&(params.id=(jc.page.data()||{}).id),"index"!=params.page||params.id)if(params.confirmed){if(!params.pdataParsed&&(params.mute||jc.progress(AS.label("DeletingPage")),params.pdataParsed=!0,!params.pdata)){if(!jc.page.data()||!jc.page.data().pageContent)return void jc.page.loadData(params.page,params.id,pdata=>{params.pdata=pdata,jc.page.rm(params)});params.pdata=jc.page.data().pageContent}if(!params.modelsChecked&&(params.modelsChecked=!0,jc.prop.site.models||(jc.prop.site.models=[]),jc.prop.site.models.find(x=>x.type==params.page&&x.id==params.id)))return jc.prop.site.models=jc.prop.site.models.filter(x=>!(x.type==params.page&&x.id==params.id)),void jc.template.part.put("header.json",jc.prop.site,()=>{jc.page.rm(params)});if(!params.uploadsDeleted&&AS.test.arr(params.pdata.uploads)&&params.pdata.uploads.length){let uploads=params.pdata.uploads.clone(),process=()=>{var url=uploads.shift().uri;jc.dav.rm(url,()=>{uploads.length?process():(params.uploadsDeleted=!0,jc.page.rm(params))})};process()}else if(AS.test.udef(params.typelist))jc.lists.list.get(params.page,l=>{params.typelist=l||{},jc.page.rm(params)});else if(AS.test.udef(params.fulllist))jc.lists.list.get(l=>{params.fulllist=l||{},jc.page.rm(params)});else if(params.removed){if(!params.listsPurged)return delete params.fulllist[params.page][String(params.id||0)],delete params.typelist[String(params.id||0)],void jc.lists.list.set(params.fulllist,()=>{jc.lists.list.set(params.page,params.typelist,()=>{params.listsPurged=!0,jc.page.rm(params)})});if(params.lastsPurged){if(!params.tagsPurged)return params.pdata.metadata||(params.pdata.metadata={}),params.pdata.metadata.deleted=!0,void jc.page.makeTagsAll(params.pdata,()=>{jc.plugin.call("savedPageTags",params),$(document.body).trigger("jc_saved_page_tags",params),params.tagsPurged=!0,jc.page.rm(params)});params.mute||(jc.progress(!1),params.noDialog||window.setTimeout(()=>{Swal.fire({title:AS.label("PageErasedTitle"),text:AS.label("PageErasedBody",{page:params.page,id:params.id}),icon:"success",showCancelButton:!1,showConfirmButton:!1,timer:2e3,timerProgressBar:!0})},100)),AS.test.func(params.callback)?params.callback.call(window,params.page,params.id,params.data):(jc.edit&&jc.edit.data(!1),jc.page.current("-"),jc.page.open("index"))}else jc.page.makeLasts(params.fulllist,()=>{jc.page.makeTypeLasts(params.page,params.typelist,()=>{jc.page.makeTypeDates(params.page,params.typelist,()=>{params.lastsPurged=!0,jc.page.rm(params)})})})}else jc.dav.rm(AS.path("jsdatapages")+params.page+(params.id||"")+".json",()=>{jc.dav.rm(AS.path("jsdatastatics")+params.page+(params.id||"")+".html",()=>{params.removed=!0,jc.page.rm(params)})})}else Swal.fire({title:AS.label("DeleteThisPage"),html:'<div style="white-space:pre;">'+AS.label("PageEraseBody",{page:params.page,id:params.id})+"</div>",icon:"warning",showDenyButton:!1,showCancelButton:!0,cancelButtonText:AS.label("Cancel"),confirmButtonText:AS.label("OK")}).then(result=>{result.isConfirmed&&(params.confirmed=!0,jc.page.rm(params))});else Swal.fire({title:AS.label("Warning"),text:AS.label("CantDeleteIndex"),icon:"error"})},jc.page.save=params=>{if(AS.test.udef(params)?params={}:AS.test.func(params)&&(params={callback:params}),params.paramsChecked||(AS.test.udef(params.data)&&(params.data=jc.edit.data()||jc.page.data().pageContent),AS.test.udef(params.page)&&(params.page=jc.page.current()),AS.test.udef(params.id)&&(params.id=params.data.id),params.maintenance&&(AS.test.udef(params.mute)&&(params.mute=!0),AS.test.udef(params.noDialog)&&(params.noDialog=!0),AS.test.udef(params.noLists)&&(params.noLists=!0),AS.test.udef(params.noStatic)&&(params.noStatic=!0),AS.test.udef(params.noTags)&&(params.noTags=!0)),params.noLists&&(params.noFullList=params.noTypeList=params.noLasts=!0),params.noFullList&&AS.test.udef(params.noTypeList)&&(params.noTypeList=!0),params.noFullList&&AS.test.udef(params.noTags)&&(params.noTags=!0),params.paramsChecked=!0),params.mute||jc.progress(AS.label("SavingPage")),AS.test.udef(params.typelist))jc.lists.list.get(params.page,l=>{params.typelist=l||{},jc.page.save(params)});else if(AS.test.udef(params.fulllist))jc.lists.list.get(l=>{params.fulllist=l||{},jc.page.save(params)});else{if("new"==params.id){if(!params.isNew)return params.isNew=!0,void jc.template.info.get(params.page,i=>{jc.objFind(i,"prop","blogdate")&&(params.data.blogdate=(new Date).tosqldate()),jc.page.save(params)});if(Object.keys(params.typelist).length){let max=0;Object.keys(params.typelist).forEach(n=>{n=parseInt(n);!isNaN(n)&&n>=max&&(max=n+1)}),0<max&&(params.id=max)}else params.id=1}if(params.metadataChecked||(AS.test.udef(params.data.metadata)&&(params.data.metadata={}),Object.keys(params.data).forEach(k=>{AS.test.arr(params.data[k])&&params.data[k].forEach(i=>{AS.test.obj(i)&&!AS.test.arr(i)&&delete i._})}),params.id&&(params.data.id=params.data.metadata.id=parseInt(params.id)),params.data.metadata.type=params.page,!params.data.metadata.description&&AS.test.str(params.data.abstract)&&(params.data.metadata.description=params.data.abstract.dehtml().shorten(256)),!params.data.metadata.title&&AS.test.str(params.data.title)&&(params.data.metadata.title=params.data.title.dehtml().shorten(48)),params.data.metadata.title||(params.data.metadata.title=params.page+(params.id?" "+params.id:"")),params.data.blogdate&&(params.data.metadata.date=params.data.blogdate),params.maintenance&&params.data.metadata.upd||(params.data.metadata.upd=(new Date).getTime()),params.metadataChecked=!0),!params.modelsChecked){let savesite;if(params.modelsChecked=!0,jc.prop.site.models||(jc.prop.site.models=[]),params.data.metadata.model){savesite=!0,jc.prop.site.models=jc.prop.site.models.filter(x=>!(x.type==params.page&&x.id==params.id));let nt={title:params.data.metadata.title,type:params.page};AS.test.def(params.id)&&(nt.id=params.id),jc.prop.site.models.push(nt),jc.prop.site.models.sort((a,b)=>(a,b)=>a.title.toLowerCase()>b.title.toLowerCase()?1:-1)}else jc.prop.site.models.find(x=>x.type==params.page&&x.id==params.id)&&(savesite=!0,jc.prop.site.models=jc.prop.site.models.filter(x=>!(x.type==params.page&&x.id==params.id)));if(savesite)return void jc.template.part.put("header.json",jc.prop.site,()=>{jc.page.save(params)})}if(params.saved){if(!params.noFullList&&!params.savedFullList)return AS.test.udef(params.fulllist[params.page])&&(params.fulllist[params.page]={}),params.fulllist[params.page][String(params.id||0)]=JSON.parse(JSON.stringify(params.data.metadata)),params.mute||jc.progress(AS.label("SavingArticleList")),void jc.lists.list.set(params.fulllist,()=>(jc.plugin.call("savedPageFulllist",params),$(document.body).trigger("jc_saved_page_fulllist",params),jc.prop.site&&jc.prop.site.norss?(params.savedFullList=!0,void jc.page.save(params)):void jc.lists.list.dositemap(params.fulllist,()=>{jc.plugin.call("savedSiteMap",params),$(document.body).trigger("jc_saved_sitemap",params),params.savedFullList=!0,jc.page.save(params)})));if(!params.noTypeList&&!params.savedTypeList)return params.typelist[String(params.id||0)]=JSON.parse(JSON.stringify(params.data.metadata)),void jc.lists.list.set(params.page,params.typelist,()=>{jc.plugin.call("savedPageTypelist",params),$(document.body).trigger("jc_saved_page_typelist",params),params.savedTypeList=!0,jc.page.save(params)});if(!params.noLasts&&!params.savedLasts)return params.mute||jc.progress(AS.label("SavingLasts")),void jc.page.makeLasts(params.fulllist,()=>{jc.plugin.call("savedPageLasts",params),$(document.body).trigger("jc_saved_page_lasts",params),jc.page.makeTypeLasts(params.page,params.typelist,()=>{params.savedLasts=!0,jc.page.save(params)})});if(params.noLasts||params.savedDates){if(!params.noTags&&!params.savedTags)return params.mute||jc.progress(AS.label("SavingTags")),void jc.page.makeTagsAll(params.data,()=>{jc.plugin.call("savedPageTags",params),$(document.body).trigger("jc_saved_page_tags",params),params.savedTags=!0,jc.page.save(params)});if(params.mute||jc.progress(!1),params.isNew||params.noDialog||params.mute||window.setTimeout(()=>{Swal.fire({title:AS.label("PageSavedTitle"),text:AS.label("PageSavedBody",{page:params.page,id:params.id}),icon:"success",showCancelButton:!1,showConfirmButton:!1,timer:1500,timerProgressBar:!0})},100),!params.staticSet){let makeStatic=()=>{var afterStatic=done=>{done&&$(document.body).off("jc_render_end",makeStatic),jc.plugin.call("savedPageFull",params),$(document.body).trigger("jc_saved_page_full",params)};params.noStatic||params.isNew?afterStatic():jc.page.makeStatic(afterStatic)};$(document.body).on("jc_render_end",makeStatic),params.staticSet=!0}jc.plugin.call("savedPage",params),$(document.body).trigger("jc_saved_page",params),AS.test.func(params.callback)?params.callback.call(window,params.page,params.id,params.data):(jc.edit&&jc.edit.data(!1),jc.page.current("-"),jc.page.open(params.page,params.id))}else jc.page.makeTypeDates(params.page,params.typelist,()=>{jc.plugin.call("savedPageDates",params),$(document.body).trigger("jc_saved_page_dates",params),params.savedDates=!0,jc.page.save(params)})}else jc.jdav.put(AS.path("jsdatapages")+params.page+(params.id||"")+".json",params.data,()=>{jc.plugin.call("savedPageData",params),$(document.body).trigger("jc_saved_page_data",params),params.saved=!0,jc.page.save(params)})}},jc.page.makeStatic=cb=>{if(jc.prop.site&&jc.prop.site.nostatic)AS.test.func(cb)&&cb.call(window,!0);else if($(".jcEditable").length)AS.test.func(cb)&&cb.call(window,!1);else{$(document.body).trigger("jc_saving_static");var uri=AS.path("jsdatastatics")+jc.page.current()+(jc.page.data()&&jc.page.data().id||jc.page.data().pageContent&&jc.page.data().pageContent.id||"")+".html",cn=document.body.className,cs=document.body.getAttribute("style");document.body.className="",document.body.style="",$("ins").remove();let $de=$(document.documentElement),html=$de.html();document.body.className=cn,document.body.style=cs,jc.plugin.call("savingStaticPre",html),html=html.replace(/(<script [^>]+\/jscms\/js\/jc-load\.js"[^>]*>[^<]*<\/script>)[\s\S]*?>\s*(<\/head>)/,"$1$2").replace(/[ \t]*<script [^>]+AS-autoload[^>]+>[^<]*<\/script>[\r\n]*/g,"").replace(/[ \t]*<script [^>]+facebook\.(com|net)[^>]+>[^<]*<\/script>[\r\n]*/g,"").replace(/<!--type:part=fbcomments[\s\S]*?<!--\/type:part-->/,"").replace(/<!--type:ads[\s\S]*?<!--\/type:ads-->/g,"").replace(/\n*<div id="fb-root" [\s\S]+?<\/div>\n+/,"").replace(/\n*<div [^>]+swal2-container[\s\S]+?<div [^>]+swal2-timer-progress-bar[^>]+>([\s\S]*?<\/div>\n*){4}/,"").replace(/\n*<div [^>]*class="[^"]*modal[ "][\s\S]+?<div [^>]*class="[^"]*modal-backdrop[^>]+>[^<]*<\/div>\n*/,"").replace(/\n*<div [^>]*class="[^"]*modal[ "][\s\S]+<\/div>\n*<\/body>/,"</body>").replace(/(<meta[^>]+content="),+([^>]+>)/g,"$1$2").replace(/<nav [\s\S]+?<\/nav>/g,"").replace(/<svg [\s\S]+?<\/svg>/g,""),jc.plugin.call("savingStaticCleaned",html),html="<!DOCTYPE html>\n<html"+($de.attr("lang")?' lang="'+$de.attr("lang")+'"':"")+">\n"+html+"\n</html>",jc.dav.put(uri,html,()=>{jc.plugin.call("savedStatic",html),$(document.body).trigger("jc_saved_static"),AS.test.func(cb)&&cb.call(window,!0)})}},jc.page.makeLasts=(list,callback)=>{if(AS.test.obj(list)){let lasts=[];Object.keys(list).forEach(t=>{let typelist=list[t];Object.keys(typelist).forEach(k=>{typelist[k].hidden||lasts.push(JSON.parse(JSON.stringify(typelist[k])))})}),lasts.sort((a,b)=>b.upd-a.upd);let qts=jc.prop.lastChangedQuantities.clone().map(i=>parseInt(i)).filter(i=>!isNaN(i)).sort((a,b)=>b-a),makeRss=!(jc.prop.site&&jc.prop.site.norss),proc=()=>{var qt;qts.length?(qt=qts.shift(),lasts.splice(qt),makeRss?(makeRss=!1,qts.unshift(qt),jc.lists.last.dorss("site",qt,lasts,proc)):jc.lists.last.set(qt,lasts,proc)):AS.test.func(callback)&&callback.call(window)};proc()}else jc.lists.list.get(l=>{jc.page.makeLasts(l||{},callback)})},jc.page.makeTypeLasts=(pagetype,typelist,callback)=>{if(jc.edit.prop.pageTypesInfo[pagetype].service)AS.test.func(callback)&&callback.call(window);else if(AS.test.obj(typelist)){let lasts=[];Object.keys(typelist).forEach(k=>{typelist[k].hidden||lasts.push(JSON.parse(JSON.stringify(typelist[k])))}),lasts.sort((a,b)=>b.upd-a.upd);let qts=jc.prop.lastChangedQuantities.clone().map(i=>parseInt(i)).filter(i=>!isNaN(i)).sort((a,b)=>b-a),proc=()=>{var qt;qts.length?(qt=qts.shift(),lasts.splice(qt),jc.lists.last.set(pagetype,qt,lasts,proc)):AS.test.func(callback)&&callback.call(window)};proc()}else jc.lists.list.get(pagetype,l=>{typelist=l||{},jc.page.makeTypeLasts(pagetype,typelist,callback)})},jc.page.makeTypeDates=(pagetype,typelist,callback)=>{if(jc.edit.prop.pageTypesInfo[pagetype].service||"_all"!=pagetype&&!jc.edit.prop.pageTypesInfo[pagetype].hasdate)AS.test.func(callback)&&callback.call(window);else if(AS.test.obj(typelist)){let aggr={};Object.keys(typelist).forEach(dp=>{const pm=typelist[dp];pm.hidden||!AS.test.str(pm.date)||3==(dp=pm.date.split("-")).length&&(aggr[dp[0]]=AS.def.arr(aggr[dp[0]]),aggr[dp[0]].push(pm),aggr[dp[0]+"-"+dp[1]]=AS.def.arr(aggr[dp[0]+"-"+dp[1]]),aggr[dp[0]+"-"+dp[1]].push(pm))});let flist=Object.keys(aggr).map(sel=>{let mlist=aggr[sel];return mlist.sort((a,b)=>a.date==b.date?a.upd<b.ud?-1:1:a.date<b.date?-1:1),{prefix:sel,list:mlist}}),purged=!1,indexes={byyear:{},bymonth:{}},proc=()=>{if(purged)if(flist.length){var f=flist.shift();4==f.prefix.length?(AS.test.udef(indexes.byyear[f.prefix])&&(indexes.byyear[f.prefix]=0),indexes.byyear[f.prefix]+=f.list.length):(AS.test.udef(indexes.bymonth[f.prefix])&&(indexes.bymonth[f.prefix]=0),indexes.bymonth[f.prefix]+=f.list.length),jc.jdav.put("struct/"+pagetype+"-bydate-"+f.prefix+".json",f.list,proc)}else{let ylist=[];Object.keys(indexes.byyear).forEach(k=>{ylist.push(k)}),ylist.sort().reverse(),indexes.byyear=ylist.map(k=>({key:k,file:"struct/"+pagetype+"-bydate-"+k+".json",qt:indexes.byyear[k]}));let mlist=[];Object.keys(indexes.bymonth).forEach(k=>{mlist.push(k)}),mlist.sort().reverse(),indexes.bymonth=mlist.map(k=>({key:k,file:"struct/"+pagetype+"-bydate-"+k+".json",qt:indexes.bymonth[k]})),jc.jdav.put("struct/"+pagetype+"-bydate-index.json",indexes,()=>{AS.test.func(callback)&&callback.call(window)})}else jc.dav.purge({dir:"struct",match:pagetype+"-bydate-",ext:"json"},()=>{purged=!0,proc()})};proc()}else jc.lists.list.get(pagetype,l=>{typelist=l||{},jc.page.makeTypeDates(pagetype,typelist,callback)})},jc.page.makeTagsAll=(pd,callback,pdtags,tagslist)=>{if(AS.test.udef(pdtags)&&(pdtags=jc.objFindAll(pd,"type","tags").clone()),(tagslist=AS.test.udef(tagslist)?AS.def.arr(jc.prop.site.tags).clone():tagslist).length){let thistag=tagslist.shift();jc.lists.tag.get(thistag.name,ndata=>{ndata=jc.page.parseTagsOne(pd,thistag.name,ndata,pdtags);jc.lists.tag.set(thistag.name,ndata,()=>{jc.page.makeTagsAll(pd,callback,pdtags,tagslist)})})}else AS.test.func(callback)&&callback.call(window)},jc.page.parseTagsOne=(pd,tagname,tdata,pdtags)=>{if(AS.test.udef(pdtags)&&(pdtags=jc.objFindAll(pd,"type","tags")),pd.metadata){let ttags=jc.objFindAll(pdtags,"name",tagname),md={type:String(pd.metadata.type)};if(pd.metadata.id&&(md.id=parseInt(pd.metadata.id)),md.title=String(pd.metadata.title),md.upd=parseInt(pd.metadata.upd),Object.keys(tdata).forEach(k=>{tdata[k]=tdata[k].filter(x=>x.type!=md.type||x.id!=md.id),tdata[k].length||delete tdata[k]}),ttags.length&&!pd.metadata.deleted){pd.metadata.hidden&&(md.hidden=!0);let atags={};ttags.forEach(tc=>{tc.tags&&tc.tags.length&&tc.tags.forEach(t=>{atags[t.tag]=!0})}),Object.keys(atags).forEach(k=>{AS.test.udef(tdata[k])&&(tdata[k]=[]),tdata[k].unshift(md)})}}return tdata},jc.page.upload=(fld,...args)=>{let options={},callback;args.forEach(a=>{AS.test.func(a)?callback=a:AS.test.obj(a)&&(options=a)});const page=jc.page.current();let pdata=jc.page.data().pageContent;const id=pdata.id,prefix=page+(id||"");let uploads=AS.def.arr(pdata.uploads),news=[],indexes=[];for(let i=0;i<fld.files.length;i++)fld.files[i].size&&fld.files[i].size<jc.prop.maxUploadSize&&indexes.push(i);if(0==indexes.length)return fld.value="",void(AS.test.func(callback)&&callback.call(window,[],uploads));const process=()=>{let tf=fld.files[indexes.shift()],oname=tf.name;options.mute||jc.progress(oname);let ext=oname.replace(/.*\.([^.]+)$/,"$1").toLowerCase();var newname=AS.generateId(prefix)+"."+ext;let url=AS.path("jsdataroot")+"uploads/"+newname;tf.arrayBuffer().then(binary=>{binary=new DataView(binary);jc.dav.put(url,binary,sortf=>{if(sortf){let no={name:oname,ext:ext,uri:url,size:tf.size,type:tf.type,added:(new Date).getTime()};no.type&&no.type.length?0==no.type.indexOf("audio/")?no.fb=no.au=!0:0==no.type.indexOf("video/")?no.fb=no.vid=!0:0==no.type.indexOf("image/")?no.fb=no.img=!0:no.type.match(/\/pdf$/)&&(no.fb=!0):no.type="application/octet-stream",no.caption=options.caption||no.name.replace(/^(.*)\.[^.]+$/,"$1").replace(/[._ -]+/g," ").trim(),uploads.push(no),news.push(no)}if(indexes.length)process();else{sortf=(a,b)=>a.name.toLowerCase()<b.name.toLowerCase()?-1:1;uploads.sort(sortf),news.sort(sortf),fld.value="",pdata.uploads=uploads;let params={data:pdata,page:page,noLasts:!0,noFullList:!0,noDialog:!0,mute:!!options.mute,callback:()=>{options.mute||jc.progress(),AS.test.func(callback)&&callback.call(window,news,uploads)}};AS.test.def(id)&&(params.id=id),jc.page.save(params)}})})};process()},jc.page.uploadBlob=(blob,...args)=>{let options,callback,info;args.forEach(a=>{AS.test.func(a)?callback=a:AS.test.obj(a)&&a.uri?info=a:AS.test.obj(a)&&(options=a)}),AS.test.udef(info)&&(info={}),AS.test.udef(options)&&(options={});let prevuri=info.uri;const page=options.page||jc.page.current();let pdata=jc.page.data().pageContent;const id=options.id||pdata.id;let uploads=AS.def.arr(pdata.uploads);if(options.purged&&(uploads=uploads.filter(x=>x.uri!=options.purged)),blob.size&&(info.size=blob.size),info.size>jc.prop.maxUploadSize)AS.test.func(callback)&&callback.call(window,!1,uploads);else{blob.type&&blob.type.length&&(info.type=blob.type),info.type||(info.type=options.type||"application/octet-stream"),!info.ext&&blob.name&&(info.ext=blob.name.replace(/^.*\.([^.]+)$/,"$1").toLowerCase()),!info.ext&&info.type&&(info.ext=info.type.replace(/^[^\/]+\/([^ ;]+).*$/,"$1").toLowerCase()),0==info.type.indexOf("audio/")?info.fb=info.au=!0:0==info.type.indexOf("video/")?info.fb=info.vid=!0:0==info.type.indexOf("image/")?info.fb=info.img=!0:info.type.match(/\/pdf$/)&&(info.fb=!0);let news=[];info.name?info.name=info.name.replace(/\.[^.]+$/,"")+"."+info.ext:blob.name?info.name=blob.name:(info.name=info.type.replace(/\/.*/,"")+"_"+(new Date).tosqldate().replace(/[^0-9]+/g,"-")+"."+info.ext,info.caption||(info.caption=options.caption||info.type.replace(/\/.*/,"")+" "+(new Date).tosql())),info.caption||(info.caption=options.caption||info.name.replace(/^(.*)\.[^.]+$/,"$1").replace(/[._-]+/g," ")),info.uri&&0==info.uri.indexOf(AS.path("jsdataroot"))?info.uri=info.uri.replace(/\.[^.]+$/,"."+info.ext):info.uri=AS.path("jsdataroot")+"uploads/"+AS.generateId(page+(id||""))+"."+info.ext,!prevuri||info.uri==prevuri||options.purged?(uploads=uploads.filter(x=>x.uri!=info.uri),info.added=(new Date).getTime(),info.caption||(info.caption=options.caption||info.name.replace(/^(.*)\.[^.]+$/,"$1").replace(/[._ -]+/g," ").trim()),blob.arrayBuffer().then(binary=>{binary=new DataView(binary);jc.dav.put(info.uri,binary,sortf=>{sortf&&(uploads.push(info),news.push(info));sortf=(a,b)=>a.name.toLowerCase()<b.name.toLowerCase()?-1:1;uploads.sort(sortf),news.sort(sortf),pdata.uploads=uploads;let params={data:pdata,page:page,noLasts:!0,noFullList:!0,noDialog:!0,mute:!!options.mute,callback:()=>{options.mute||jc.progress(),AS.test.func(callback)&&callback.call(window,news,uploads)}};AS.test.def(id)&&(params.id=id),jc.page.save(params)})})):jc.page.rmUpload({uri:prevuri},()=>{options.purged=prevuri,jc.page.uploadBlob(blob,info,options,callback)})}},jc.page.rmUpload=(item,callback)=>{let recurse=n=>{if(AS.test.arr(n)){if(n.length)return n[0].uri?n.filter(i=>i.uri!=item.uri):n.map(i=>recurse(i))}else AS.test.obj(n)&&Object.keys(n).forEach(k=>{n[k]=recurse(n[k])});return n},pdata=recurse(jc.page.data().pageContent);jc.page.save({data:pdata,page:jc.page.current(),id:jc.page.data().pageContent.id,noLasts:!0,noFullList:!0,mute:!0,noDialog:!0,callback:()=>{jc.dav.rm(item.uri,()=>{jc.progress(),AS.test.func(callback)&&callback.call(window,pdata)})}})},jc.edit={prop:{blockTypes:[{type:"text",label:"TextOrHtml",menu:!0},{type:"youtube",label:"YtVimeo",menu:!0},{type:"gallery",label:"Gallery",menu:!0},{type:"tags",label:"Tags",menu:!0},{type:"pbytag",label:"PagesByTags"},{type:"relateds",label:"RelatedPages"},{type:"audio",label:"Audio"},{type:"video",label:"Video"},{type:"lasts",label:"LastChangedPages"},{type:"subpage",label:"IncludePage"},{type:"part",label:"IncludePagePart"}],formPlugins:["basic","pikaday","tinymce","iro","slider"],repo:{}},onload:()=>{AS.addEvent(document,"as:tinyMceInited",e=>{e.detail.getWrap().querySelector(".tox-tinymce").style.height=String(Math.min(Math.max(parseInt(window.innerHeight)-240,300),640))+"px"}),jc.edit.loadFormPlugins(),jc.edit.getRepository(),jc.edit.loadPageTypes(),jc.edit.loadPageParts(),jc.plugin.call("editLoaded"),$(document.body).trigger("jc_edit_loaded")},loadFormPlugins:()=>{if(AS.form&&AS.form.plugin){jc.edit.prop.formPlugins.forEach(p=>{AS.form.plugin(p)});const rawplugins=()=>{if(!AS.form.fields||!AS.form.fields.select)return window.setTimeout(rawplugins,100);jc.springLoad(AS.path("jscdn")+"libs/as-form-jcplugins"+(jc.prop.isDeveloper?"":".min")+".js")};rawplugins()}else window.setTimeout(jc.edit.loadFormPlugins,100)},getRepository:(pagetype,callback)=>{AS.test.udef(pagetype)&&(pagetype=jc.page.current()),jc.template.repo.get(pagetype,callback)},setRepository:jc.template.repo.set,loadPageTypes:force=>{!force&&jc.edit.prop.pageTypes||(jc.edit.prop.pageTypes=!0,jc.edit.prop.pageTypesInfo={},jc.jdav.get(AS.path("jsauth")+"auth/lstemplates",r=>{jc.edit.prop.pageTypes=r.list.clone();const getinfo=()=>{if(r.list.length){let k=r.list.shift();jc.template.info.get(k,d=>{jc.edit.prop.pageTypesInfo[k]={display:d.display||k,service:d.service||!1,hasdate:!!jc.objFind(d,"prop","blogdate")},getinfo()})}};getinfo()}))},loadPageParts:force=>{!force&&jc.edit.prop.pageParts||(jc.edit.prop.pageParts=!0,jc.jdav.get(AS.path("jsauth")+"auth/lsparts",r=>{jc.edit.prop.pageParts=r.list}))},maintenance:confirmed=>{if(confirmed)return jc.maint?void jc.maint.start():(jc.springLoad("module:maintenance"),window.setTimeout(()=>{jc.edit.maintenance(confirmed)},300));Swal.fire({title:AS.label("MaintenanceConfirmTitle"),html:AS.label("MaintenanceConfirmBody"),icon:"question",showDenyButton:!1,showCancelButton:!0,cancelButtonText:AS.label("Cancel"),confirmButtonText:AS.label("OK")}).then(result=>{result.isConfirmed&&jc.edit.maintenance(!0)})},start:()=>{jc.edit.getRepository(),document.querySelectorAll(".jcEditable:not(.jcEditableParsed)").forEach(data=>{let $d=$(data);data=$d.data("editable");if(data||!AS.test.obj(data)){$d.addClass("jcEditableParsed");let $em=$('<div class="jcEditMenu"></div>');"page"==jc.page.prop.editMode?(AS.test.def(data._)&&AS.test.def(data._.idx)?($d.on("dblclick",jc.edit.edit),data._.idx<data._.qt-1&&$em.append('<span class="jcEditMoveDown" onclick="jc.edit.movedown(event)">'+AS.icon("moveDown")+"</span>"),data._.idx&&$em.append('<span class="jcEditMoveUp" onclick="jc.edit.moveup(event)">'+AS.icon("moveUp")+"</span>"),$em.append('<span class="jcEditDropdown">'+AS.icon("menu")+"</span>")):"mixed"==data.subtype?$em.append('<span class="jcEditDropdown">'+AS.icon("editAdd")+"</span>"):($d.on("dblclick",jc.edit.edit),$em.append('<span class="jcEditDropdown">'+AS.icon("edit")+"</span>")),$d.prepend($em),$d.on("contextmenu",jc.edit.menu),$(".jcEditMenu .jcEditDropdown",$d).on("click contextmenu",jc.edit.menu)):"parts"==jc.page.prop.editMode&&($d.on("dblclick",jc.edit.part),$em.append('<span class="jcEditDropdown">'+AS.icon("edit")+"</span>"),$d.prepend($em),$d.on("contextmenu",jc.edit.part),$(".jcEditMenu .jcEditDropdown",$d).on("click contextmenu",jc.edit.part))}else $d.removeClass("jcEditable")})},data:d=>{if(0==d)jc.prefs.purge("onEditData");else{if(AS.test.obj(d))return jc.prefs.key("onEditData",{page:jc.page.current(),id:jc.page.data().id,data:d}),jc.prefs.key("onEditData").data;if("page"==jc.page.prop.editMode){let theSame=(d=jc.prefs.key("onEditData"))&&d.page==jc.page.current();if(theSame&&d.id&&(theSame=d.id==jc.page.data().id),theSame)return d.data;jc.prefs.purge("onEditData")}}},menu:e=>{var data=jc.edit.itemdata(e);let hl=".jcEditable",acts=[{icon:"jcicon",iconKey:"edit",label:AS.label("blockEditContent"),action:jc.edit.edit}];if(data.subtype){let canAdd=AS.test.def(data._)&&AS.test.def(data._.idx);if("mixed"==data.subtype?(hl=!1,canAdd=!0,acts.shift()):canAdd&&("subpage"==data.subtype&&acts.push("-",{icon:"jcicon",iconKey:"editGo",label:AS.label("GotoPage"),action:jc.edit.gotoSubpage}),acts.push("-",{icon:"jcicon danger",iconKey:"editRemove",label:AS.label("blockDeleteContent"),action:jc.edit.rm},"-")),canAdd){let addItem={icon:"jcicon",iconKey:"editAdd",ricon:"jcicon",riconKey:"arrow-down",label:AS.label("blockAddContent"),action:jc.edit.add};if(1<jc.edit.prop.blockTypes.length){addItem.label+="…";let vt=jc.edit.prop.blockTypes.filter(t=>t.menu);vt.length&&(addItem.content=vt.map(t=>({label:AS.label(t.label),action:e=>{jc.edit.add(e,t.type)}})))}acts.push(addItem)}}if(acts.length){if(1==acts.length)return acts[0].action.call(window,e);acts.unshift("Block: "+(data.subtype||data.type)),jc.menu(e,{content:acts,highlight:hl})}},itemdata:e=>(e.preventDefault(),e.stopPropagation(),$(e.target).closest(".jcEditable").data("editable")),gotoSubpage:b=>{b=jc.edit.itemdata(b);let p=jc.edit.data()[b.prop];AS.test.arr(p)&&AS.test.def(b._.idx)&&(p=p[b._.idx][b.subtype]),AS.test.obj(p)&&jc.page.open(p.page,p.id)},moveup:b=>{b=jc.edit.itemdata(b);let d=jc.edit.data();Array.isArray(d[b.prop])&&(d[b.prop].splice(b._.idx-1,2,d[b.prop][b._.idx],d[b.prop][b._.idx-1]),jc.edit.fixBlocks(b,d),jc.page.reload())},movedown:b=>{b=jc.edit.itemdata(b);let d=jc.edit.data();Array.isArray(d[b.prop])&&(d[b.prop].splice(b._.idx,2,d[b.prop][b._.idx+1],d[b.prop][b._.idx]),jc.edit.fixBlocks(b,d),jc.page.reload())},edit:e=>{let b=jc.edit.itemdata(e),d=jc.edit.data(),t=b.subtype||b.type;if(jc.edit.custom[t])jc.edit.custom[t].edit(b,d);else if(jc.edit.form[t]){let $mod=jc.edit.getModal(!0);$mod.on("shown.bs.modal",()=>{AS.form.create(jc.edit.form[t].call(window,b,d))}),$mod.modal("show")}},form:{_base:(b,d)=>{var $mod=jc.edit.getModal();let t=b.subtype||b.type;return $(".modal-dialog",$mod).append(`<div class="modal-content">
				<div class="modal-header bg-light">
					<p class="modal-title">
						<span class="jcicon">${AS.icon("edit")}</span> 
						<b>
							${AS.label("Edit")} “${jc.page.current()}”${jc.page.data().id?" ID: "+jc.page.data().id:""},
							${b.prop}${AS.test.def(b._)&&AS.test.def(b._.qt)?" ["+(AS.test.num(b._.idx)?String(b._.idx+1)+"/"+b._.qt:b._.idx)+"]":""}
						</b>
					</p>
					<button type="button" class="close" onclick="jc.edit.noModal()" aria-label="Close">
						<span aria-hidden="true" class="jcicon modalCloser">${AS.icon("circleClose")}</span>
					</button>
				</div>
				<div class="modal-body" id="jcPageEditor"></div>
			</div>`),{options:{effectduration:0,theme:"transparent",subforms:[],jsaction:(fd,fo)=>{fo.destroy(),jc.edit.noModal(),AS.test.def(b._)&&AS.test.def(b._.qt)?(d[b.prop][b._.idx]=fd,jc.edit.fixBlocks(b,d)):AS.test.def(fd[t])?(d[b.prop]=fd[t],jc.edit.data(d)):d[b.prop]=fd,jc.page.reload()}},fields:[["btns","buttons",{position:"bottom",list:[{label:AS.label("Cancel"),icon:AS.icon("circleClose"),onclick:jc.edit.noModal},{btype:"reset"},{btype:"submit"}]}]],target:"jcPageEditor",callback:f=>{b._&&b._.qt?f.parse(d[b.prop][b._.idx]):AS.test.def(d[b.prop])&&f.setValue(t,d[b.prop])}}},lasts:(b,vtypes)=>{let o=jc.edit.form._base(b,vtypes),ptypes=[{label:AS.label("Choose"),value:""},{label:"* "+AS.label("All"),value:"_all"}];jc.edit.prop.pageTypes.filter(k=>!jc.edit.prop.pageTypesInfo[k].service).forEach(k=>{ptypes.push({label:jc.edit.prop.pageTypesInfo[k].display,value:k})});vtypes=[{label:AS.label("Numbered list"),value:"ol,li"},{label:AS.label("Bullet list"),value:"ul,li"},{label:AS.label("Plain list"),value:"div,div"}];return o.fields.push(["type","hidden",{value:"lasts"}],["ptype","select",{asLabel:"PageType",options:ptypes,skipempty:!0,mandatory:!0}],["title","text",{asLabel:"Title",normalize:!0,skipempty:!0,depends:"ptype"}],["view","select",{asLabel:"blockTextAspect",options:vtypes,depends:"ptype"}],["max","slider",{asLabel:"Max",min:1,max:100,report:{value:!0},default:10,depends:"ptype"}],["showdate","bool",{asLabel:"ShowDate",depends:"ptype"}],["showtime","bool",{asLabel:"ShowTime",depends:"showdate"}],["showdesc","bool",{asLabel:"ShowDesc",depends:"ptype"}]),o},date:(b,d)=>{let o=jc.edit.form._base(b,d);return o.fields.push(["date","date",{asLabel:"Date",skypempty:!0,asTitle:"onlyNonEmptyFields",format:"YYYY-MM-DD",default:(new Date).tosqldate()}],["footer","freehtml",{value:"<br />"}]),o},part:(b,d)=>{let o=jc.edit.form._base(b,d),opts=jc.edit.prop.pageParts.clone();return opts.sort(),opts.unshift({label:AS.label("Choose")+"…",value:""}),o.fields.push(["part","select",{asLabel:"PageType",options:opts,mandatory:!0}],["type","hidden",{value:"part"}],["footer","freehtml",{value:"<br />"}]),o},text:(b,d)=>{let o=jc.edit.form._base(b,d);return b._&&AS.test.def(b._.qt)?o.fields.push(["type","select",{asLabel:"blockType",default:"text",options:[{label:AS.label("HTML"),value:"html"},{label:AS.label("Text"),value:"text"}],onchange:(x,fo)=>{let f=fo.getForm();["text","html"].forEach(fn=>{f.fieldByName(fn).disable(),f.fieldByName(fn).hide()});let rf=f.fieldByName(x);rf.setValue(rf.realField&&rf.realField()?rf.realField().value:""),rf.enable(),rf.show()}}],["html","html",{nolabel:!0,trim:!0,asTitle:"onlyNonEmptyFields",value:""}],["wrap","select",{asLabel:"blockTextAspect",default:"<h4></h4>",options:[{label:AS.label("H3"),value:"<h3></h3>"},{label:AS.label("H4"),value:"<h4></h4>"},{label:AS.label("Text"),value:"<div></div>"},{label:AS.label("Note (warning)"),value:'<div class="alert alert-warning jcWarning" role="alert"></div>'},{label:AS.label("Code"),value:'<div class="jcCode"></div>'}],depends:"type=text"}],["text","textarea",{nolabel:!0,trim:!0,asTitle:"onlyNonEmptyFields",value:""}]):o.fields.push(["text","textarea",{nolabel:!0,trim:!0,asTitle:"onlyNonEmptyFields",value:""}]),o},html:(b,d)=>{let o=jc.edit.form._base(b,d);return o.fields.push(["type","select",{asLabel:"blockType",default:"html",options:[{label:AS.label("HTML"),value:"html"},{label:AS.label("Text"),value:"text"}],onchange:(x,fo)=>{let f=fo.getForm();["text","html"].forEach(fn=>{f.fieldByName(fn).disable(),f.fieldByName(fn).hide()});let rf=f.fieldByName(x);rf.setValue(rf.realField&&rf.realField()?rf.realField().value:""),rf.enable(),rf.show()}}],["html","html",{nolabel:!0,trim:!0,asTitle:"onlyNonEmptyFields",value:""}],["wrap","select",{asLabel:"blockTextAspect",default:"<h4></h4>",options:[{label:AS.label("H3"),value:"<h3></h3>"},{label:AS.label("H4"),value:"<h4></h4>"},{label:AS.label("Text"),value:"<div></div>"},{label:AS.label("Note (warning)"),value:'<div class="alert alert-warning jcWarning" role="alert"></div>'},{label:AS.label("Code"),value:'<div class="jcCode"></div>'}],depends:"type=text"}],["text","textarea",{nolabel:!0,trim:!0,asTitle:"onlyNonEmptyFields",value:""}]),o},subpage:(b,d)=>{let o=jc.edit.form._base(b,d);return o.fields.push(["title","freehtml",{value:"<h5>"+AS.label("BlocksFromPage")+"</h5>"}],["type","hidden",{value:"subpage"}],["subpage","jcpage",{nolabel:!0,skypempty:!0,mandatory:!0}],["force","bool",{asLabel:"ForceAlsoHidden",depends:"subpage"}],["footer","freehtml",{value:"<br />"}]),o},youtube:(b,d)=>{let o=jc.edit.form._base(b,d);return o.fields.push(["type","hidden",{value:"youtube"}],["youtube","text",{asLabel:"URL",focus:!0,normalize:!0,skipempty:!0,mandatory:!0}]),o},relateds:(b,d)=>{let o=jc.edit.form._base(b,d);return o.options.subforms.push({name:"item",subtype:"array",preview:["label"],values:[["label","text",{asLabel:"Label",normalize:!0,mandatory:!0}],["item","jcpage",{nolabel:!0,includecurrent:!1,jconchange:(f,t)=>{var v=AS.test.obj(f.prop.value)?f.prop.value.page+(f.prop.value.id||""):"",t=$('option[value="'+v+'"]',t).attr("title")||"";f.getForm().setValue("label",t,!0)}}]]}),o.fields.push(["type","hidden",{value:"relateds"}],["title","text",{asLabel:"Title",normalize:!0,skipempty:!0}],["view","select",{asLabel:"View",options:[{label:AS.label("Bullet list"),value:"ul,li"},{label:AS.label("Numbered list"),value:"ol,li"},{label:AS.label("Plain list"),value:"div,div"}]}],["position","select",{asLabel:"Position",options:[{label:AS.label("Block"),value:""},{label:AS.label("FloatRight"),value:"jcBoxRight"}]}],["relateds","subform",{asLabel:"Content",subform:"item",mandatory:!0}]),o},pbytag:(b,tfinit)=>{let o=jc.edit.form._base(b,tfinit);tfinit=(fo,tf)=>{tf=tf.select2("data")[0].id;let sf=fo.getForm().fieldByName("tv").prop.subforms.find(x=>"tagvals"==x.name);jc.lists.tag.get(tf,l=>{sf.values.find(x=>"tv"==x[0])[2].options=Object.keys(l)})};return o.options.subforms.push({name:"tagvals",subtype:"array",preview:["tv"],values:[["tv","select2",{asLabel:"Value",options:[],select2:{allowClear:!1,tags:!1}}]]},{name:"tagfamily",subtype:"array",preview:["tf"],values:[["tf","select2",{asLabel:"Tag",options:AS.def.arr(jc.prop.site.tags).map(x=>({value:x.name,label:x.label||x.name})),select2:{allowClear:!1,tags:!1},jconchange:tfinit,jconrender:tfinit}],["op","select",{asLabel:"Operator",options:[{label:"OR",value:"or"},{label:"AND",value:"and"}]}],["tv","subform",{asLabel:"Values",subform:"tagvals"}]]}),o.fields.push(["type","hidden",{value:"relateds"}],["title","text",{asLabel:"Title",normalize:!0,skipempty:!0}],["view","select",{asLabel:"View",options:[{label:AS.label("Bullet list"),value:"ul,li"},{label:AS.label("Numbered list"),value:"ol,li"},{label:AS.label("Plain list"),value:"div,div"}]}],["position","select",{asLabel:"Position",options:[{label:AS.label("Block"),value:""},{label:AS.label("FloatRight"),value:"jcBoxRight"}]}],["op","select",{asLabel:"Operator",options:[{label:"OR",value:"or"},{label:"AND",value:"and"}]}],["rules","subform",{asLabel:"Filter",subform:"tagfamily",mandatory:!0}]),o}},add:(e,t)=>{let ob=jc.edit.itemdata(e),d=jc.edit.data();if(1==jc.edit.prop.blockTypes.length&&(t=jc.edit.prop.blockTypes[0]),AS.test.str(t))jc.edit.addType(ob,d,t);else{let ml=AS.label("Mains")+":",ol=AS.label("Others")+":",opts={};opts[ml]={},jc.edit.prop.blockTypes.filter(t=>t.menu).forEach(t=>{opts[ml][t.type]=AS.label(t.label)}),opts[ol]={},jc.edit.prop.blockTypes.filter(t=>!t.menu).forEach(t=>{opts[ol][t.type]=AS.label(t.label)}),Swal.fire({title:AS.label("SelectBlockType"),text:AS.label("SelectBlockTypeDesc"),input:"select",icon:"question",inputOptions:opts,inputPlaceholder:AS.label("Choose")+"…",showCancelButton:!0,cancelButtonText:AS.label("Cancel"),confirmButtonText:AS.label("OK"),inputValidator:v=>new Promise(resolve=>{v.length?resolve():resolve(AS.label("SelectBlockType"))})}).then(result=>{result.isConfirmed&&jc.edit.addType(ob,d,result.value)})}},addType:(b,d,t)=>{jc.edit.custom[t]?jc.edit.custom[t].add(b,d):jc.edit.addByForm(b,d,t)},addByForm:(b,d,t)=>{let nb={prop:b.prop,_:{idx:AS.label("New")}};!b._||AS.test.udef(b._.qt)?nb._.qt=0:nb._.qt=b._.qt;let $mod=jc.edit.getModal(!0),fopt=jc.edit.form[t].call(window,nb,d);fopt.options.jsaction=(fd,fo)=>{fo.destroy(),jc.edit.noModal(),b._&&AS.test.def(b._.qt)?d[b.prop].splice(b._.idx,1,d[b.prop][b._.idx],fd):(AS.test.arr(d[b.prop])||(d[b.prop]=[]),d[b.prop].push(fd)),jc.edit.fixBlocks(b,d),jc.page.reload()},fopt.callback=f=>{AS.test.def(t)&&b._&&"text"==t?f.setValue("type","html"):AS.test.def(t)?f.setValue("type",t):b._||AS.test.udef(b._.qt)?f.setValue("type","html"):f.setValue("type",d[b.prop][b._.idx].type)},$mod.on("shown.bs.modal",()=>{AS.form.create(fopt)}).modal("show")},fixBlocks:(b,d)=>{let qt=d[b.prop].length;d[b.prop].forEach((x,i)=>{x._||(x._={}),x._.idx=i,x._.qt=qt}),jc.edit.data(d)},rm:b=>{b=jc.edit.itemdata(b);let d=jc.edit.data();Array.isArray(d[b.prop])&&(d[b.prop].splice(b._.idx,1),jc.edit.data(d),jc.page.reload())},part:e=>{let b=jc.edit.itemdata(e);b.target=e.target,b.type=AS.test.obj(b.raw)?"object":"html",jc.edit.partEdit(b)},partEdit:(data,fo)=>{if("object"==data.type&&AS.test.udef(data.repo))jc.template.part.get(data.src,{repo:!0},repo=>{data.repo=repo,jc.edit.partEdit(data,fo)});else{if(AS.test.udef(fo)){if("object"==data.type)return void data.repo.form(rfo=>{(fo=rfo).callback=f=>{f.parse(data.raw)},fo.options.jsaction=(fd,f)=>{f.destroy(),jc.edit.noModal(),jc.template.part.put(data.src,fd,()=>{jc.page.reload()})},jc.edit.partEdit(data,fo)});fo={options:{theme:"transparent",subforms:[],jsaction:(fd,f)=>{f.destroy(),jc.edit.noModal(),jc.template.part.put(data.src,fd.html,()=>{jc.page.reload()})}},fields:[["html","html",{nolabel:!0,trim:!0,asTitle:"onlyNonEmptyFields",value:""}]],callback:f=>{f.setValue("html",data.raw)}}}let $mod=jc.edit.getModal(!0);$(".modal-dialog",$mod).append(`<div class="modal-content">
				<div class="modal-header bg-light">
					<p class="modal-title">
						<span class="jcicon">${AS.icon("edit")}</span> 
						<b> ${AS.label("Edit")} “${data.src}” </b>
					</p>
					<button type="button" class="close" onclick="jc.edit.noModal()" aria-label="Close">
						<span aria-hidden="true" class="jcicon modalCloser">${AS.icon("circleClose")}</span>
					</button>
				</div>
				<div class="modal-body" id="jcPageEditor"></div>
			</div>`),fo.target="jcPageEditor",fo.options.effectduration=0,fo.fields.push(["hr","hr",{position:"bottom"}],["btns","buttons",{position:"bottom",list:[{label:AS.label("Cancel"),icon:AS.icon("circleClose"),onclick:jc.edit.noModal},{btype:"submit"}]}]),$mod.on("shown.bs.modal",()=>{AS.form.create(fo)}),$mod.modal("show")}},getModal:buildNew=>{if(buildNew){let f;for(;f=AS.form.getForm();)f.destroy();$("#jcEditModalLg").remove()}let mod=$("#jcEditModalLg");return 0==mod.length&&(mod=$('<div id="jcEditModalLg" class="modal" tabindex="-1"><div class="modal-dialog modal-lg"></div></div>'),$(document.body).append(mod)),mod},noModal:()=>{jc.edit.getModal().modal("hide").remove()}},jc.edit.meta={edit:options=>{var pagetype=(options=AS.def.obj(options)).pagetype||jc.page.current(),pd=options.pageData||jc.page.data();let ed=options.editData||jc.edit.data();if(options.form){AS.test.udef(ed.metadata)&&(ed.metadata={type:jc.page.current(),id:pd.id});let $mod=jc.edit.getModal(!0);$(".modal-dialog",$mod).append(`<div class="modal-content">
			<div class="modal-header bg-info text-white">
				<p class="modal-title">
					<span class="jcicon">${AS.icon("metadata")}</span> 
					<b>${AS.label("Metadata")}</b>
				</p>
				<button type="button" class="close" onclick="jc.edit.noModal()" aria-label="Close">
					<span aria-hidden="true" class="jcicon modalCloser">${AS.icon("circleClose")}</span>
				</button>
			</div>
			<div class="modal-body" id="jcPageEditor"></div></div>`),options.form.callback=f=>{ed.metadata&&f.parse(ed.metadata)},options.form.target="jcPageEditor",options.form.options.effectduration=0,options.form.options.theme="light",options.form.options.title=`“${ed.metadata.type}”${ed.metadata.id?" ID: "+ed.metadata.id:""}`,options.form.fields.push(["btns","buttons",{position:"bottom",list:[{label:AS.label("Cancel"),icon:AS.icon("circleClose"),onclick:"()=>{jc.edit.noModal();}"},{btype:"reset"},{btype:"submit",asLabel:"Done"}]}]),options.form.options.jsaction=(fd,f)=>{f.destroy(),jc.edit.noModal(),ed.metadata=fd,options.callback?options.callback.call(window,ed):jc.edit.data(ed)},$mod.on("shown.bs.modal",()=>{AS.form.create(options.form)}).modal("show")}else jc.edit.getRepository(pagetype,repo=>{repo&&repo.form&&repo.form.metadata?(options.form=JSON.parse(JSON.stringify(repo.form.metadata)),jc.edit.meta.edit(options)):jc.edit.getRepository("index",repo=>{options.form=JSON.parse(JSON.stringify(repo.form.metadata)),jc.edit.meta.edit(options)})})}},jc.edit.custom={audio:{getModal:empty=>{var $mod=jc.edit.getModal(empty);return empty&&$(".modal-dialog",$mod).append(`<div class="modal-content">
					<div class="modal-header bg-info text-white">
						<p class="modal-title">
							<span class="jcicon">${AS.icon("audio")}</span> 
							<b>${AS.label("Audio")}</b>
						</p>
						<button type="button" class="close" onclick="jc.edit.noModal()" aria-label="Close">
							<span aria-hidden="true" class="jcicon modalCloser">${AS.icon("circleClose")}</span>
						</button>
					</div>
					<div class="modal-body" id="jcPageAudio"></div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" onclick="jc.edit.noModal()">${AS.label("Cancel")}</button>
						<button type="button" disabled="disabled" class="btn btn-primary jcMediaSaver">${AS.label("Save")}</button>
					</div>
				</div>`),$mod},add:(b,d,prevb)=>{var canRecord=!!window.MediaRecorder;let prevd,blob,$mod=jc.edit.custom.audio.getModal(!0);prevb&&(prevd=prevb.uri?prevb:prevb.audio);let pdata=jc.page.data().pageContent;if(pdata.uploads&&pdata.uploads.filter(x=>x.au&&(!prevd||x.uri!=prevd.uri)).length){let $sa=$('<div class="jcMediaSelectArea"></div>'),$s=$("<select></select>");var preva=!!prevd&&pdata.uploads.find(x=>x.uri==prevd.uri);$s.append('<option value="">'+(preva?"["+preva.ext+": "+preva.caption+"]":AS.label("Choose")+"…")+"</option>"),pdata.uploads.filter(x=>x.au&&(!prevd||x.uri!=prevd.uri)).forEach(u=>{$s.append(`<option value="${u.uri}">${u.ext}: ${u.caption}</option>`)}),$sa.on("change",()=>{var issel=$s.val().length;$(".jcMediaRecordArea, .jcMediaUploadArea",$mod).toggle(!issel),$(".jcMediaSaver",$mod).attr("disabled",!issel)});const $hflex=$('<hflex class="wrap"></hflex>');$hflex.append(`<div>${AS.label("ChooseAudio")}:</div>`,$s),$(".modal-body",$mod).append($sa.append($hflex))}let $ra=$('<div class="jcMediaRecordArea"></div>');if($ra){if(canRecord){let chunks=[],mediaRecorder;const $audio=$('<audio src="" controls="controls">This browser doesn’t support HTML5 audio</audio>'),$bt=$('<button type="button" class="btn btn-primary jcMediaToggler"><span class="jcicon">'+AS.icon("mic")+"</span></button>"),$btd=$('<button type="button" class="btn btn-danger jcMediaDeleter" disabled="disabled"><span class="jcicon">'+AS.icon("editRemove")+"</span></button>"),$btp=$('<button type="button" class="btn btn-secondary jcMediaPauser ml-2" style="display:none;"><span class="jcicon">'+AS.icon("pause")+"</span></button>"),$hflex=$('<hflex class="wrap"></hflex>');AS.test.obj(prevd)&&prevd.uri&&($audio.attr("src",prevd.uri),$btd.attr("disabled",!1)),$hflex.append(`<div>${AS.label("RecordAudio")}:</div>`,$audio,$('<div class="btn-group"></div>').append($bt,$btd),$btp),$ra.append($hflex);const doPreview=()=>{doBlob(),blob?($audio.get(0).src=URL.createObjectURL(blob),mediaRecorder&&mediaRecorder.state&&"paused"==mediaRecorder.state||($(".jcMediaSaver, .jcMediaDeleter",$mod).attr("disabled",!1),mediaRecorder=!1)):($audio.get(0).src="",$(".jcMediaSaver, .jcMediaDeleter",$mod).attr("disabled",!0)),$(".jcMediaSelectArea, .jcMediaUploadArea",$mod).toggle(!blob)},doBlob=()=>blob=chunks.length?new Blob(chunks,{type:mediaRecorder.mimeType}):!1;$bt.on("click",()=>{mediaRecorder?mediaRecorder.stop():(async()=>{chunks=[];let supported={},constraints={};try{supported=navigator.mediaDevices.getSupportedConstraints()}catch(e){}constraints.audio={},constraints.video=!1,supported.latency&&(constraints.latency=constraints.audio.latency={ideal:0}),supported.channelCount&&(constraints.channelCount=constraints.audio.channelCount={ideal:1}),supported.sampleSize&&(constraints.sampleSize=constraints.audio.sampleSize={ideal:8,max:16}),supported.noiseSuppression&&(constraints.noiseSuppression=constraints.audio.noiseSuppression={ideal:!0}),supported.echoCancellation&&(constraints.echoCancellation=constraints.audio.echoCancellation={ideal:!0}),supported.sampleRate&&(constraints.sampleRate=constraints.audio.sampleRate={min:16e3,ideal:32e3,max:48e3}),Object.keys(constraints.audio).length||(constraints.audio=!0);let stream;for(;!stream;)try{stream=await navigator.mediaDevices.getUserMedia(constraints)}catch(e){delete constraints[e.constraint],AS.test.obj(constraints.audio)&&delete constraints.audio[e.constraint],Object.keys(constraints.audio).length||(constraints.audio=!0)}let options={mimeType:'audio/mp4"',audioBitsPerSecond:9600};try{mediaRecorder=new MediaRecorder(stream,options)}catch(e){delete options.mimeType;try{mediaRecorder=new MediaRecorder(stream,options)}catch(e){mediaRecorder=new MediaRecorder(stream)}}mediaRecorder.addEventListener("start",e=>{$bt.removeClass("btn-primary").addClass("btn-danger"),mediaRecorder.pause&&$btp.removeClass("btn-warning").addClass("btn-secondary").show(),$(".jcMediaSaver, .jcMediaDeleter",$mod).attr("disabled",!0),$("span",$bt).html(AS.icon("stop")),$ra.addClass("recording")}),mediaRecorder.addEventListener("dataavailable",e=>{e.data&&chunks.push(e.data)}),mediaRecorder.addEventListener("stop",e=>{$bt.removeClass("btn-danger").addClass("btn-primary"),mediaRecorder.pause&&$btp.removeClass("btn-warning").addClass("btn-secondary").hide(),$ra.removeClass("recording"),$("span",$bt).html(AS.icon("mic")),stream.getTracks().forEach(track=>track.stop()),doPreview()}),mediaRecorder.addEventListener("pause",e=>{$ra.removeClass("recording"),$btp.removeClass("btn-secondary").addClass("btn-warning"),doPreview()}),mediaRecorder.addEventListener("resume",e=>{$ra.addClass("recording"),$btp.removeClass("btn-warning").addClass("btn-secondary")}),mediaRecorder.start(3e5)})()}),$btp.on("click",()=>{mediaRecorder&&("paused"==mediaRecorder.state?mediaRecorder.resume():mediaRecorder.pause())}),$btd.on("click",()=>{mediaRecorder||(chunks=[],doPreview())})}else $ra.append('<div class="alert alert-warning" role="alert">'+AS.label("BrowserMediaRecorderMissing")+"</div>");$(".modal-body",$mod).append($ra)}let $ua=$('<div class="jcMediaUploadArea"></div>');if($ua){let $uf=$('<input type="file" class="jcMediaUploadField" accept="audio/*" />');const $hflex=$('<hflex class="wrap"></hflex>');$hflex.append(`<div>${AS.label("ChooseAudio")}:</div>`,$uf),$uf.on("change",()=>{var issel=$uf.val().length;$(".jcMediaRecordArea, .jcMediaSelectArea",$mod).toggle(!issel),$(".jcMediaSaver",$mod).attr("disabled",!issel)}),$(".modal-body",$mod).append($ua.append($hflex))}$mod.on("shown.bs.modal",()=>{$("button.jcMediaSaver",$mod).on("click",()=>{var finalize;!blob&&$(".jcMediaUploadField").val().length&&(blob=$(".jcMediaUploadField").get(0).files[0]),blob?(finalize={type:"audio/webm"},jc.page.uploadBlob(blob,prevd||{},finalize,(nd,uploads)=>{nd=nd[0];nd&&(nd={type:"audio",audio:{uri:nd.uri}},jc.edit.custom.audio.save(b,d,nd,prevb))})):$(".jcMediaSelectArea select",$mod).val().length&&(finalize=()=>{var nd={type:"audio",audio:{uri:$(".jcMediaSelectArea select",$mod).val()}};jc.edit.custom.audio.save(b,d,nd,prevb)},prevd&&prevd.uri&&prevd.uri.length?jc.page.rmUpload(prevd,finalize):finalize())})}),$mod.modal({show:!0,keyboard:!1})},edit:(b,d)=>{jc.edit.custom.audio.add(b,d,d[b.prop][b._.idx])},save:(b,d,newd,oldd)=>{AS.test.obj(oldd)?d[b.prop].splice(b._.idx,1,newd):b._&&AS.test.def(b._.qt)?d[b.prop].splice(b._.idx,1,d[b.prop][b._.idx],newd):(AS.test.arr(d[b.prop])||(d[b.prop]=[]),d[b.prop].push(newd)),jc.edit.fixBlocks(b,d),jc.edit.noModal(),jc.page.reload()}},video:{getModal:empty=>{var $mod=jc.edit.getModal(empty);return empty&&$(".modal-dialog",$mod).append(`<div class="modal-content">
					<div class="modal-header bg-info text-white">
						<p class="modal-title">
							<span class="jcicon">${AS.icon("video")}</span> 
							<b>${AS.label("Video")}</b>
						</p>
						<button type="button" class="close" onclick="jc.edit.noModal()" aria-label="Close">
							<span aria-hidden="true" class="jcicon modalCloser">${AS.icon("circleClose")}</span>
						</button>
					</div>
					<div class="modal-body" id="jcPageVideo"></div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" onclick="jc.edit.noModal()">${AS.label("Cancel")}</button>
						<button type="button" disabled="disabled" class="btn btn-primary jcMediaSaver">${AS.label("Save")}</button>
					</div>
				</div>`),$mod},add:(b,d,prevb)=>{var canRecord=!!window.MediaRecorder;let prevd,blob,$mod=jc.edit.custom.video.getModal(!0);prevb&&(prevd=prevb.uri?prevb:prevb.video);let pdata=jc.page.data().pageContent;if(pdata.uploads&&pdata.uploads.filter(x=>x.vid&&(!prevd||x.uri!=prevd.uri)).length){let $sa=$('<div class="jcMediaSelectArea"></div>'),$s=$("<select></select>");var preva=!!prevd&&pdata.uploads.find(x=>x.uri==prevd.uri);$s.append('<option value="">'+(preva?"["+preva.ext+": "+preva.caption+"]":AS.label("Choose")+"…")+"</option>"),pdata.uploads.filter(x=>x.vid&&(!prevd||x.uri!=prevd.uri)).forEach(u=>{$s.append(`<option value="${u.uri}">${u.ext}: ${u.caption}</option>`)}),$sa.on("change",()=>{var issel=$s.val().length;$(".jcMediaRecordArea, .jcMediaUploadArea",$mod).toggle(!issel),$(".jcMediaSaver",$mod).attr("disabled",!issel)});const $hflex=$('<hflex class="wrap"></hflex>');$hflex.append(`<div>${AS.label("ChooseVideo")}:</div>`,$s),$(".modal-body",$mod).append($sa.append($hflex))}let $ra=$('<div class="jcMediaRecordArea"></div>');if($ra){if(canRecord){let chunks=[],mediaRecorder;const $video=$('<video src="" style="max-height:'+parseInt($(window).height()-300)+'px;" controls="controls">This browser doesn’t support HTML5 video</video>'),$bt=$('<button type="button" class="btn btn-primary jcMediaToggler"><span class="jcicon">'+AS.icon("video")+"</span></button>"),$btd=$('<button type="button" class="btn btn-danger jcMediaDeleter" disabled="disabled"><span class="jcicon">'+AS.icon("editRemove")+"</span></button>"),$btp=$('<button type="button" class="btn btn-secondary jcMediaPauser ml-2" style="display:none;"><span class="jcicon">'+AS.icon("pause")+"</span></button>"),$hflex=$('<hflex class="wrap"></hflex>');AS.test.obj(prevd)&&prevd.uri&&($video.attr("src",prevd.uri),$btd.attr("disabled",!1)),$hflex.append(`<div>${AS.label("RecordVideo")}:</div>`,$video,$('<div class="btn-group"></div>').append($bt,$btd),$btp),$ra.append($hflex);const doPreview=()=>{doBlob(),blob?mediaRecorder&&mediaRecorder.state&&"paused"==mediaRecorder.state||($(".jcMediaSaver, .jcMediaDeleter",$mod).attr("disabled",!1),mediaRecorder=!1):($video.get(0).src=null,$(".jcMediaSaver, .jcMediaDeleter",$mod).attr("disabled",!0)),$(".jcMediaSelectArea, .jcMediaUploadArea",$mod).toggle(!blob)},doBlob=()=>blob=chunks.length?new Blob(chunks,{type:mediaRecorder.mimeType}):!1;$bt.on("click",()=>{mediaRecorder?mediaRecorder.stop():(async()=>{chunks=[];let supported={},constraints={};try{supported=navigator.mediaDevices.getSupportedConstraints()}catch(e){}constraints.audio={},constraints.video={},supported.latency&&(constraints.latency=constraints.audio.latency={ideal:0}),supported.channelCount&&(constraints.channelCount=constraints.audio.channelCount={ideal:1}),supported.sampleSize&&(constraints.sampleSize=constraints.audio.sampleSize={ideal:8,max:16}),supported.noiseSuppression&&(constraints.noiseSuppression=constraints.audio.noiseSuppression={ideal:!0}),supported.echoCancellation&&(constraints.echoCancellation=constraints.audio.echoCancellation={ideal:!0}),supported.sampleRate&&(constraints.sampleRate=constraints.audio.sampleRate={min:16e3,ideal:32e3,max:48e3}),supported.width&&(constraints.width=constraints.video.width={min:480,ideal:640,max:1280}),supported.height&&(constraints.height=constraints.video.height={min:270,ideal:304,max:720}),supported.aspectRatio&&(constraints.aspectRatio=constraints.video.aspectRatio={ideal:16/9}),supported.frameRate&&(constraints.frameRate=constraints.video.frameRate={min:10,ideal:15,max:30}),supported.facingMode&&(constraints.facingMode=constraints.video.facingMode={exact:"user"}),Object.keys(constraints.audio).length||(constraints.audio=!0),Object.keys(constraints.video).length||(constraints.video=!0);let stream;for(;!stream;)try{stream=await navigator.mediaDevices.getUserMedia(constraints)}catch(e){console.log(e),delete constraints[e.constraint],AS.test.obj(constraints.video)&&delete constraints.video[e.constraint],AS.test.obj(constraints.audio)&&delete constraints.audio[e.constraint],Object.keys(constraints.audio).length||(constraints.audio=!0),Object.keys(constraints.video).length||(constraints.video=!0)}let options={mimeType:'video/mp4"',audioBitsPerSecond:9600,videoBitsPerSecond:64e4};try{mediaRecorder=new MediaRecorder(stream,options)}catch(e){options={mimeType:'video/webm;codecs="opus,vp8"'};try{mediaRecorder=new MediaRecorder(stream,options)}catch(e){mediaRecorder=new MediaRecorder(stream)}}mediaRecorder.addEventListener("start",e=>{$bt.removeClass("btn-primary").addClass("btn-danger"),mediaRecorder.pause&&$btp.removeClass("btn-warning").addClass("btn-secondary").show(),$(".jcMediaSaver, .jcMediaDeleter",$mod).attr("disabled",!0),$("span",$bt).html(AS.icon("stop")),$ra.addClass("recording")}),mediaRecorder.addEventListener("dataavailable",e=>{e.data&&chunks.push(e.data)}),mediaRecorder.addEventListener("stop",e=>{$bt.removeClass("btn-danger").addClass("btn-primary"),mediaRecorder.pause&&$btp.removeClass("btn-warning").addClass("btn-secondary").hide(),$("span",$bt).html(AS.icon("video")),$ra.removeClass("recording"),stream.getTracks().forEach(track=>track.stop()),doPreview()}),mediaRecorder.addEventListener("pause",e=>{$btp.removeClass("btn-secondary").addClass("btn-warning"),$ra.removeClass("recording"),doPreview()}),mediaRecorder.addEventListener("resume",e=>{$ra.addClass("recording"),$btp.removeClass("btn-warning").addClass("btn-secondary")}),mediaRecorder.start(3e5)})()}),$btp.on("click",()=>{mediaRecorder&&("paused"==mediaRecorder.state?mediaRecorder.resume():mediaRecorder.pause())}),$btd.on("click",()=>{mediaRecorder||(chunks=[],doPreview())})}else $ra.append('<div class="alert alert-warning" role="alert">'+AS.label("BrowserMediaRecorderMissing")+"</div>");$(".modal-body",$mod).append($ra)}let $ua=$('<div class="jcMediaUploadArea"></div>');if($ua){let $uf=$('<input type="file" class="jcMediaUploadField" accept="video/*" />');const $hflex=$('<hflex class="wrap"></hflex>');$hflex.append(`<div>${AS.label("ChooseVideo")}:</div>`,$uf),$uf.on("change",()=>{var issel=$uf.val().length;$(".jcMediaRecordArea, .jcMediaSelectArea",$mod).toggle(!issel),$(".jcMediaSaver",$mod).attr("disabled",!issel)}),$(".modal-body",$mod).append($ua.append($hflex))}$mod.on("shown.bs.modal",()=>{$("button.jcMediaSaver",$mod).on("click",()=>{if(!blob&&$(".jcMediaUploadField").val().length&&(blob=$(".jcMediaUploadField").get(0).files[0]),blob){var finalize={type:"video/webm"};let pd={};return prevd&&(pd.uri=prevd.uri),void jc.page.uploadBlob(blob,pd,finalize,(nd,uploads)=>{nd=nd[0];nd&&(nd={type:"video",video:{uri:nd.uri}},jc.edit.custom.video.save(b,d,nd,prevb))})}$(".jcMediaSelectArea select",$mod).val().length&&(finalize=()=>{var nd={type:"video",video:{uri:$(".jcMediaSelectArea select",$mod).val()}};jc.edit.custom.video.save(b,d,nd,prevb)},prevd&&prevd.uri&&prevd.uri.length?jc.page.rmUpload(prevd,finalize):finalize())})}),$mod.modal({show:!0,keyboard:!1})},edit:(b,d)=>{jc.edit.custom.video.add(b,d,d[b.prop][b._.idx])},save:(b,d,newd,oldd)=>{AS.test.obj(oldd)?d[b.prop].splice(b._.idx,1,newd):b._&&AS.test.def(b._.qt)?d[b.prop].splice(b._.idx,1,d[b.prop][b._.idx],newd):(AS.test.arr(d[b.prop])||(d[b.prop]=[]),d[b.prop].push(newd)),jc.edit.fixBlocks(b,d),jc.edit.noModal(),jc.page.reload()}},gallery:{getModal:empty=>{var $mod=jc.edit.getModal(empty);return empty&&$(".modal-dialog",$mod).append(`<div class="modal-content">
					<div class="modal-header bg-info text-white">
						<p class="modal-title">
							<span class="jcicon">${AS.icon("uploads")}</span> 
							<b>${AS.label("Attachments")}</b>
						</p>
						<button type="button" class="close" onclick="jc.edit.noModal()" aria-label="Close">
							<span aria-hidden="true" class="jcicon modalCloser">${AS.icon("circleClose")}</span>
						</button>
					</div>
					<div class="modal-body" id="jcPageUploads"></div></div>`),$mod},add:(b,d)=>{let nb={prop:b.prop,type:"block",subtype:"gallery",_:{idx:AS.label("New")}};var nd={type:"gallery",gallery:[]};b._&&AS.test.def(b._.qt)?d[b.prop].splice(b._.idx,1,d[b.prop][b._.idx],nd):(AS.test.arr(d[b.prop])||(d[b.prop]=[]),d[b.prop].push(nd)),jc.edit.fixBlocks(b,d),nb._.idx=nd._.idx,jc.edit.custom.gallery.edit(nb,d)},edit:(b,d)=>{AS.test.arr(d.uploads)||(d.uploads=[]);let bd=d[b.prop][b._.idx];AS.test.arr(bd.gallery)||(bd.gallery=[]);let $mod=jc.edit.custom.gallery.getModal(!0),params={target:$("#jcPageUploads",$mod),reloader:()=>{jc.edit.custom.gallery.edit(b,d)},select:!0,gallery:bd};$mod.on("shown.bs.modal",()=>{jc.edit.uploads.render(params)}).modal({show:!0,keyboard:!1})}},tags:{form:(b,d,to,tdata)=>{to=to||AS.def.arr(jc.prop.site&&jc.prop.site.tags).find(x=>AS.test.obj(x)&&x.name&&x.name==d[b.prop][b._.idx].name);let o=jc.edit.form._base(b,d);var isStrict=!(!to.strict||!to.strict.length),useProps=!(!to.props||!to.props.length);o.options.title=to.label||to.name,o.fields.push(["type","hidden",{value:"tags"}],["name","hidden",{value:to.name}],["show","bool",{asLabel:"Visibile",checked:"New"==b._.idx}],["view","select",{asLabel:"blockTextAspect",options:[{label:AS.label("Compact"),value:"p,span"},{label:AS.label("Bullet list"),value:"ul,li"},{label:AS.label("Numbered list"),value:"ol,li"},{label:AS.label("Plain list"),value:"div,div"}],depends:"show"}],["position","select",{asLabel:"Position",options:[{label:AS.label("Block"),value:""},{label:AS.label("FloatRight"),value:"jcBoxRight"}],depends:"show"}],["showtitle","bool",{asLabel:"Title",checked:"New"==b._.idx,depends:"show"}],["customtitle","text",{asLabel:"Title",placeholder:to.label||to.name,normalize:!0,skipempty:!0,depends:"showtitle"}]),useProps&&o.fields.push(["verbose","bool",{asLabel:"Verbose",depends:"show"}]),o.fields.push(["tags","subform",{asLabel:"Tags",subform:"tags"}],["spacer","freehtml",{value:"<br />"}]);let sf={name:"tags",subtype:"array",preview:["tag"],values:[["tag","select2",{asLabel:"Tag",options:isStrict?to.strict.map(x=>x.tag):Object.keys(tdata).sort(),select2:{allowClear:!isStrict,tags:!isStrict}}]]};return useProps&&to.props.forEach(p=>{sf.preview.push(p.name),sf.values.push([p.name,"text",{label:p.label||p.name,normalize:!0,skipempty:!0}])}),o.options.subforms.push(sf),o},add:(b,d,tt,ttdata)=>{if(!tt){if(!AS.test.obj(jc.prop.site)||!AS.test.arr(jc.prop.site.tags))return;if(1==jc.prop.site.tags.length)return void jc.edit.custom.tags.add(b,d,jc.prop.site.tags[0].name);let opts={};return jc.prop.site.tags.forEach(t=>{opts[t.name]=t.label||t.name}),void Swal.fire({title:AS.label("Tag"),text:AS.label("Select"),input:"select",icon:"question",inputOptions:opts,inputPlaceholder:AS.label("Choose")+"…",showCancelButton:!0,cancelButtonText:AS.label("Cancel"),confirmButtonText:AS.label("OK"),inputValidator:v=>new Promise(resolve=>{v.length?resolve():resolve(AS.label("Select"))})}).then(result=>{result.isConfirmed&&jc.edit.custom.tags.add(b,d,result.value)})}var tag=AS.def.arr(jc.prop.site&&jc.prop.site.tags).find(x=>AS.test.obj(x)&&x.name&&x.name==tt);if(tag)if(tag.strict&&tag.strict.length||ttdata){let nb={prop:b.prop,_:{idx:AS.label("New")}};!b._||AS.test.udef(b._.qt)?nb._.qt=0:nb._.qt=b._.qt;let $mod=jc.edit.getModal(!0),fopt=jc.edit.custom.tags.form(nb,d,tag,ttdata);fopt.options.jsaction=(fd,fo)=>{fo.destroy(),jc.edit.noModal(),b._&&AS.test.def(b._.qt)?d[b.prop].splice(b._.idx,1,d[b.prop][b._.idx],fd):(AS.test.arr(d[b.prop])||(d[b.prop]=[]),d[b.prop].push(fd)),jc.edit.fixBlocks(b,d),jc.page.reload()},$mod.on("shown.bs.modal",()=>{AS.form.create(fopt)}).modal("show")}else jc.lists.tag.get(tt,l=>{jc.edit.custom.tags.add(b,d,tt,l)})},edit:(b,d,ttdata)=>{let bd=d[b.prop][b._.idx],tag=AS.def.arr(jc.prop.site&&jc.prop.site.tags).find(x=>AS.test.obj(x)&&x.name&&x.name==bd.name);if(tag)if(tag.strict&&tag.strict.length||ttdata){let $mod=jc.edit.getModal(!0);$mod.on("shown.bs.modal",()=>{AS.form.create(jc.edit.custom.tags.form(b,d,tag,ttdata))}),$mod.modal("show")}else jc.lists.tag.get(bd.name,l=>{jc.edit.custom.tags.edit(b,d,l)})}}},jc.edit.uploads={edit:()=>{jc.page.data().pageContent;let $mod=jc.edit.getModal(!0);$(".modal-dialog",$mod).append(`<div class="modal-content">
			<div class="modal-header bg-info text-white">
				<p class="modal-title">
					<span class="jcicon">${AS.icon("uploads")}</span> 
					<b>${AS.label("Attachments")}</b>
				</p>
				<button type="button" class="close" onclick="jc.edit.noModal()" aria-label="Close">
					<span aria-hidden="true" class="jcicon modalCloser">${AS.icon("circleClose")}</span>
				</button>
			</div>
			<div class="modal-body" id="jcPageUploads"></div></div>`);let params={target:$("#jcPageUploads",$mod),reloader:()=>{jc.edit.uploads.edit()}};$mod.on("shown.bs.modal",()=>{jc.edit.uploads.render(params)}).modal({show:!0,keyboard:!1})},render:params=>{AS.test.func(params)&&(params={callback:params}),(params=AS.def.obj(params)).pageData||(params.pageData=jc.page.data().pageContent),params.uploads||(params.uploads=params.pageData.uploads),params.uploads=AS.def.arr(params.uploads),AS.test.def(params.gallery)&&!AS.test.obj(params.gallery)&&(params.gallery={}),params.gallery&&!AS.test.arr(params.gallery.gallery)&&(params.gallery.gallery=[]),jc.plugin.call("editUploadsPre",params);let $out=$("<div></div>");$out.append($(`<div class="jcUploadsAdders text-center mb-4">
			<input type="file" multiple="multiple" style="display:none" />
			<span class="btn-group">
				<button type="button" class="btn btn-sm btn-primary jcImageUpload">${AS.icon("upload")} ${AS.label("Upload")}</button>
			</span>
		</div>`));let refresh=e=>{$(document.body).off("jc_page_data_loaded",refresh),params.reloader&&!params.thenClose&&params.reloader.call(window)};if(params.gallery){let $st=$('<select class="mr-1 mt-1"><option value="T">Thumbnails</option><option value="I">Inline</option><option value="C">Carousel</option></select>'),$sp=$('<select class="mr-1 mt-1"><option value="">Center</option><option value="right">Right</option><option value="left">Left</option>'),$sf=$('<select class="mr-1 mt-1"><option value="">Plain</option><option value="c">With captions</option><option value="x">With controls</option><option value="i">With indicators</option><option value="ci">With captions + indicators</option><option value="xi">With controls + indicators</option><option value="cxi">With captions + controls + indicators</option></select>'),$ss=$('<select class="mr-1 mt-1"><option>XS</option><option>S</option><option value="">M</option><option>L</option><option>XL</option><option>XXL</option></select>');$st.val(params.gallery.aspect||"T"),$st.on("change",()=>{params.gallery.aspect=$st.val(),"C"!=params.gallery.aspect&&delete params.gallery.flags,$sf.toggle("C"==params.gallery.aspect),"I"!=params.gallery.aspect&&delete params.gallery.pos,$sp.toggle("I"==params.gallery.aspect),jc.page.save({maintenance:!0,mute:!1,callback:()=>{jc.edit.noModal(),$(document.body).on("jc_page_data_loaded",refresh),jc.page.reload()}})}),$sp.val(params.gallery.pos||"").toggle("I"==params.gallery.aspect),$sp.on("change",()=>{$sp.val().length?params.gallery.pos=$sp.val():delete params.gallery.pos,jc.page.save({maintenance:!0,mute:!1,callback:()=>{jc.edit.noModal(),$(document.body).on("jc_page_data_loaded",refresh),jc.page.reload()}})}),$sf.val(params.gallery.flags||"").toggle("C"==params.gallery.aspect),$sf.on("change",()=>{$sf.val().length?params.gallery.flags=$sf.val():delete params.gallery.flags,jc.page.save({maintenance:!0,mute:!1,callback:()=>{jc.edit.noModal(),$(document.body).on("jc_page_data_loaded",refresh),jc.page.reload()}})}),$ss.val(params.gallery.size||""),$ss.on("change",()=>{$ss.val().length?params.gallery.size=$ss.val():delete params.gallery.size,jc.page.save({maintenance:!0,mute:!1,callback:()=>{jc.edit.noModal(),$(document.body).on("jc_page_data_loaded",refresh),jc.page.reload()}})}),$(".jcUploadsAdders .btn-group",$out).append($('<span class="ml-3"></span>').append($st,$ss,$sp,$sf)),$(".jcUploadsAdders .btn-group select",$out).css({"max-width":"100px"})}if($(".jcImageUpload",$out).on("click",()=>{$('input[type="file"]',$out).trigger("click")}),$('input[type="file"]',$out).on("change",e=>{(()=>{jc.edit.noModal();jc.page.upload($('input[type="file"]',$out).get(0),{},newitems=>{var finalize=()=>{$(document.body).on("jc_page_data_loaded",refresh),jc.page.reload()};params.gallery?(newitems.forEach(i=>{params.gallery.gallery.push({uri:i.uri})}),jc.page.save({maintenance:!0,mute:!1,callback:finalize})):finalize()})})()}),params.uploads.length){let $tbl=$('<table class="jcUploads"><thead><tr></tr></thead><tbody></tbody></table>');params.gallery&&$("thead tr",$tbl).append("<th></th>"),$("thead tr",$tbl).append(`<th>${AS.label("FileName")}</th><th>${AS.label("Caption")}</th><th>${AS.label("FileSize")}</th><th></th>`);let refresh=e=>{$(document.body).off("jc_page_data_loaded",refresh),params.reloader&&params.reloader.call(window)};let rm=item=>{(item instanceof Event||item.originalEvent)&&(item=$(item.target).closest("tr").data()),jc.page.rmUpload(item,newpdata=>{jc.edit.noModal(),$(document.body).on("jc_page_data_loaded",refresh),jc.page.reload()})},makeRow=u=>{let $tr=$('<tr class="jcUpload"></tr>');if($tr.data(u),params.gallery){let $i=$('<input type="checkbox" />');params.gallery.gallery.find(k=>k.uri==u.uri)&&$i.attr("checked",!0),$tr.append("<td></td>"),$("td",$tr).append($i)}u.au?$tr.append(`<td class="fn"><a data-type="iframe" data-src="${u.uri}" href="javascript:;" data-fancybox="uploads" data-caption="${u.caption.escape()}">${u.name.escape()}</a></td>`):u.fb?$tr.append(`<td class="fn"><a href="${u.uri}" data-fancybox="uploads" data-caption="${u.caption.escape()}">${u.name.escape()}</a></td>`):$tr.append('<td class="fn">'+u.name.escape()+"</td>");let $capt=$('<input type="text" name="caption" />');$capt.attr("value",u.caption),$tr.append($('<td class="fc"></td>').append($capt)),$tr.append('<td class="fs">'+parseInt(u.size).smartSize()+"</td>");var $acts=$('<td><span class="btn-group"></span></td>');$("span",$acts).append(`<a class="btn btn-primary btn-icon btn-sm legitRipple" title="${AS.label("Download")}" href="${u.uri}" download="${u.name.escape()}"><i>${AS.icon("download")}</i></a>`);let $del=$(`<a class="btn btn-danger btn-icon btn-sm legitRipple" title="${AS.label("Delete")}">${AS.icon("editRemove")}</a>`);$del.on("click",rm),$("span",$acts).append($del),$tr.append($acts),$("tbody",$tbl).append($tr)};params.gallery&&params.gallery.gallery.length?(params.gallery.gallery.forEach(s=>{var u=params.uploads.find(k=>k.uri==s.uri);u&&makeRow(u)}),params.uploads.forEach(u=>{params.gallery.gallery.find(k=>k.uri==u.uri)||makeRow(u)})):params.uploads.forEach(u=>{makeRow(u)}),$out.append($tbl),$out.append(`<div class="text-right"><a class="btn btn-primary saveUploads">${AS.label("Save")}</a></div>`),$('input[type="checkbox"]',$tbl).on("click change",e=>{e.stopPropagation(),params.gallery.gallery=[],$('tr.jcUpload input[type="checkbox"]:checked',$out).each((_idx,u)=>{u=$(u).closest("tr").data();params.gallery.gallery.push({uri:u.uri})}),AS.test.func(params.onchange)?params.onchange.call(params.gallery.gallery.clone()):jc.page.save({maintenance:!0,mute:!1,callback:()=>{jc.edit.noModal(),$(document.body).on("jc_page_data_loaded",refresh),jc.page.reload()}})}),$('input[name="caption"]',$tbl).on("change",()=>{let capts={};$("tr.jcUpload",$out).each((_idx,tr)=>{var data=$(tr).data();let $i=$('input[name="caption"]',tr);$i.val(capts[data.uri]=String($i.val()||"").replace(/[\\"]/g,"").trim())}),params.uploads.forEach(u=>{u.caption=capts[u.uri]}),jc.page.save({maintenance:!0,mute:!1,callback:()=>{}})}),$(".saveUploads",$out).on("click",()=>{params.thenClose=!0,jc.edit.noModal()})}else $out.append('<div class="jcPlaceHolder text-center">'+AS.label("NoItemsFound")+"</div>");return jc.plugin.call("editUploadsPost",$out),params.target&&$(params.target).append($out),AS.test.func(params.callback)&&params.callback.call(window,$out),$out}},$(()=>{jc.edit.onload()});