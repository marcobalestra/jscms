jc.dav.put=(url,data,success,fail)=>{fail=jc.evalFunc(fail)||jc.evalFunc(success)||jc.getError,success=jc.evalFunc(success)||(()=>{}),url.match(jc.prop.absUriMatcher)||(url=AS.path("jsdataroot")+url),jc.console("jc.dav.put",url,data),$.ajax(url,{method:"PUT",dataType:"text",processData:!1,cache:!1,contentType:"text/plain; charset=UTF-8",data:data,error:(...errs)=>{fail.call(window,!1,errs)},success:()=>{success.call(window,!0)}})},jc.dav.mkdir=(url,success,fail)=>{fail=jc.evalFunc(fail)||jc.evalFunc(success)||jc.getError,success=jc.evalFunc(success)||(()=>{}),url.match(jc.prop.absUriMatcher)||(url=AS.path("jsdataroot")+url),jc.console("jc.dav.mkdir",url),$.ajax(url,{method:"MKCOL",cache:!1,dataType:"text",error:(...errs)=>{fail.call(window,!1,errs)},success:()=>{success.call(window,!0)}})},jc.dav.rm=(url,success,fail)=>{fail=jc.evalFunc(fail)||jc.evalFunc(success)||jc.getError,success=jc.evalFunc(success)||(()=>{}),url.match(jc.prop.absUriMatcher)||(url=AS.path("jsdataroot")+url),jc.console("jc.dav.rm",url),$.ajax(url,{method:"DELETE",cache:!1,contentType:"text/xml; charset=UTF-8",dataType:"text",error:(...errs)=>{fail.call(window,!1,errs)},success:xt=>{success.call(window,xt)}})},jc.dav.purge=(...args)=>{let success,fail,options={};args.forEach(a=>{if(AS.test.obj(a))return a.dir&&(options.dir=a.dir),a.ext&&(options.ext=a.ext),void(a.match&&(options.match=a.match));var f=jc.evalFunc(a);AS.test.func(f)&&(success?fail=f:success=f),AS.test.str(a)&&(options.dir=a)}),fail=fail||success||jc.getError,success=success||(()=>{}),options.dir&&(options.dir=options.dir.replace(/\/$/,"")),jc.dav.ls(options,out=>{let count=0,proc=()=>{var url;out.list.length?(count++,url=(out.dir?out.dir+"/":"")+out.list.shift(),jc.dav.rm(url,proc)):AS.test.func(success)&&success.call(window,count)};proc()},fail)},jc.dav.ls=(...url)=>{let success,fail,options={};url.forEach(a=>{if(AS.test.obj(a))return a.dir&&(options.dir=a.dir),a.ext&&(options.ext=a.ext),void(a.match&&(options.match=a.match));var f=jc.evalFunc(a);AS.test.func(f)&&(success?fail=f:success=f),AS.test.str(a)&&(options.dir=a)}),fail=fail||success||jc.getError,success=success||(()=>{});url=AS.path("jsauth")+"auth/lsdata";jc.console("jc.dav.ls",url),$.ajax(url,{method:"GET",cache:!1,dataType:"json",data:options,error:(...errs)=>{fail.call(window,!1,errs)},success:data=>{Object.keys(options).forEach(k=>{options[k]&&(data[k]=options[k])}),success.call(window,data)}})},jc.jdav.put=(url,data,success,fail)=>{fail=jc.evalFunc(fail)||jc.evalFunc(success)||jc.getError,success=jc.evalFunc(success)||(()=>{}),url.match(jc.prop.absUriMatcher)||(url=AS.path("jsdataroot")+url),jc.console("jc.jdav.put",url,data),$.ajax(url,{method:"PUT",cache:!1,dataType:"json",contentType:"application/json; charset=UTF-8",data:AS.test.obj(data)?JSON.stringify(data):data,error:(...errs)=>{fail.call(window,!1,errs)},success:()=>{success.call(window,!0)}})},Object.keys(jc.dav).forEach(k=>{AS.test.udef(jc.jdav[k])&&(jc.jdav[k]=jc.dav[k])}),jc.lists.list.set=(...args)=>{var type=args.find(a=>AS.test.str(a))||"_all",list=args.find(a=>AS.test.obj(a))||{};const callback=args.find(a=>AS.test.func(a));let commit=args.find(a=>AS.test.bool(a));if(AS.test.udef(commit)&&(commit=!0),jc.lists.prop.lists[type]=list,commit)return jc.lists.list.commit.apply(window,args);AS.test.func(callback)&&callback.call(window)},jc.lists.list.commit=(...args)=>{var type=args.find(a=>AS.test.str(a))||"_all";let list=args.find(a=>AS.test.obj(a));const callback=args.find(a=>AS.test.func(a));list?jc.lists.prop.lists[type]=list:list=jc.lists.prop.lists[type]||{},jc.jdav.put(jc.lists.list.uri(type),list,r=>{AS.test.func(callback)&&callback.call(window,r)})},jc.lists.last.set=(...args)=>{var type=args.find(a=>AS.test.str(a))||"_all",qt=args.find(a=>AS.test.num(a)),list=args.find(a=>AS.test.arr(a))||[];const callback=args.find(a=>AS.test.func(a));let commit=args.find(a=>AS.test.bool(a));if(AS.test.udef(commit)&&(commit=!0),jc.lists.prop.lasts[type]||(jc.lists.prop.lasts[type]={}),jc.lists.prop.lasts[type][String(qt)]=list,commit)return jc.lists.last.commit.apply(window,args);AS.test.func(callback)&&callback.call(window)},jc.lists.last.commit=(...args)=>{var type=args.find(a=>AS.test.str(a))||"_all",uri=args.find(a=>AS.test.num(a));let list=args.find(a=>AS.test.arr(a));const callback=args.find(a=>AS.test.func(a));list=list||(jc.lists.prop.lasts[type][String(uri)]||[]);uri=jc.lists.last.uri(type,uri);jc.jdav.put(uri,list,r=>{AS.test.func(callback)&&callback.call(window,r)})},jc.lists.last.dorss=(...args)=>{const type=args.find(a=>AS.test.str(a))||"_all";var uri=args.find(a=>AS.test.num(a));let list=args.find(a=>AS.test.arr(a));const callback=args.find(a=>AS.test.func(a));list=list||(jc.lists.prop.lasts[type][String(uri)]||[]);uri=jc.lists.last.uri(type,uri).replace(/\.json/,".rss");let feed='<?xml version="1.0" encoding="UTF-8" ?>\n<rss version="2.0">\n<channel>\n';feed+="<title>"+$("head title",document.documentElement).html().escape()+"</title>\n";let baseuri=window.location.protocol+"//"+window.location.hostname+"/";feed+="<link>"+baseuri+"</link>\n",feed+="<generator>jBloud CMS - jscms</generator>\n",list.forEach(i=>{var pt=i.page||type;feed+="<item>\n",feed+="\t<link>"+baseuri+pt+(i.id||"")+"/</link>\n",feed+="\t<pubDate>"+new Date(i.upd).toUTCString()+"</pubDate>\n",feed+="\t<title>"+i.title.escape()+"</title>\n",i.desc&&i.desc.length&&(feed+="\t<description><![CDATA["+i.desc+"]]></description>\n"),feed+="</item>\n"}),feed+="</channel>\n</rss>\n",jc.dav.put(uri,feed,r=>{AS.test.func(callback)&&callback.call(window,r)})},jc.page.create=options=>{if(options=AS.def.obj(options),AS.test.udef(options.page))jc.jdav.get(AS.path("jsauth")+"auth/lstemplates",l=>{let opts={};l.list.sort(),l.list.forEach(k=>{opts[k]=k}),Swal.fire({title:AS.label("SelectPageType"),text:AS.label("SelectPageTypeDesc"),input:"select",icon:"question",inputOptions:opts,inputPlaceholder:"Select",showCancelButton:!0,cancelButtonText:AS.label("Cancel"),confirmButtonText:AS.label("OK"),inputValidator:v=>new Promise(resolve=>{v.length?resolve():resolve(AS.label("SelectPageType"))})}).then(result=>{result.isConfirmed&&(options.page=result.value,jc.page.create(options))})});else if(AS.test.udef(options.template))jc.template.info.get(options.page,tdata=>{options.template=tdata,jc.page.create(options)});else{if(AS.test.udef(options.data))return options.id="new",void jc.edit.meta.edit({pageData:{},editData:{metadata:{type:options.page,id:"new"}},callback:pd=>{options.data=pd,jc.page.create(options)}});if(options.noDialog=!0,options.noLasts=!0,AS.test.obj(options.template.content)){let blocks=[];options.template.content.forEach(c=>{AS.test.arr(c.content)?c.content.forEach(d=>{AS.test.arr(d.blocks)&&d.blocks.forEach(b=>{AS.test.obj(b)&&blocks.push(b)})}):AS.test.obj(c.content)&&AS.test.arr(c.content.blocks)&&c.content.blocks.forEach(b=>{AS.test.obj(b)&&blocks.push(b)})}),blocks.length&&(options.data.metadata.title&&blocks.find(b=>"title"==b.prop)&&(options.data.title=options.data.metadata.title),options.data.metadata.description&&(blocks.find(b=>"abstract"==b.prop)?options.data.abstract=options.data.metadata.description:blocks.find(b=>"descriptions"==b.prop)&&(options.data.descriptions=options.data.metadata.description)))}options.callback=(page,id,data)=>{jc.page.prop.editMode="page",jc.page.open(page,id)},jc.page.save(options)}},jc.page.rm=params=>{if(AS.test.udef(params)?params={}:AS.test.func(params)&&(params={callback:params}),AS.test.udef(params.page)&&(params.page=jc.page.current()),AS.test.udef(params.id)&&(params.id=(jc.page.data()||{}).id),"index"!=params.page||params.id)if(params.confirmed){if(!params.pdataParsed&&(params.mute||jc.progress(AS.label("DeletingPage")),params.pdataParsed=!0,!params.pdata)){if(!jc.page.data()||!jc.page.data().pageContent)return void jc.page.loadData(params.page,params.id,pdata=>{params.pdata=pdata,jc.page.rm(params)});params.pdata=jc.page.data().pageContent}if(!params.uploadsDeleted&&AS.test.arr(params.pdata.uploads)&&params.pdata.uploads.length){let uploads=params.pdata.uploads.clone(),process=()=>{var url=uploads.shift().uri;jc.dav.rm(url,()=>{uploads.length?process():(params.uploadsDeleted=!0,jc.page.rm(params))})};process()}else if(AS.test.udef(params.typelist))jc.lists.list.get(params.page,l=>{params.typelist=l||{},jc.page.rm(params)});else if(AS.test.udef(params.fulllist))jc.lists.list.get(l=>{params.fulllist=l||{},jc.page.rm(params)});else{if(params.removed)return params.listsPurged?void(params.lastsPurged?(params.mute||(jc.progress(!1),params.noDialog||window.setTimeout(()=>{Swal.fire({title:AS.label("PageErasedTitle"),text:AS.label("PageErasedBody",{page:params.page,id:params.id}),icon:"success",showCancelButton:!1,showConfirmButton:!1,timer:2e3,timerProgressBar:!0})},100)),AS.test.func(params.callback)?params.callback.call(window,params.page,params.id,params.data):(jc.edit&&jc.edit.data(!1),jc.page.current("-"),jc.page.open("index"))):jc.page.makeLasts(param.fulllist,()=>{jc.page.makeTypeLasts(params.page,params.typelist,()=>{jc.page.makeTypeDates(params.page,params.typelist,()=>{params.lastsPurged=!0,jc.page.rm(params)})})})):(delete params.fulllist[params.page][String(params.id||0)],delete params.typelist[String(params.id||0)],void jc.lists.list.set(params.fulllist,()=>{jc.lists.list.set(params.page,params.typelist,()=>{params.listsPurged=!0,jc.page.rm(params)})}));jc.dav.rm(params.page+(params.id||"")+".json",()=>{params.removed=!0,jc.page.rm(params)})}}else Swal.fire({title:AS.label("DeleteThisPage"),html:'<div style="white-space:pre;">'+AS.label("PageEraseBody",{page:params.page,id:params.id})+"</div>",icon:"warning",showDenyButton:!1,showCancelButton:!0,cancelButtonText:AS.label("Cancel"),confirmButtonText:AS.label("OK")}).then(result=>{result.isConfirmed&&(params.confirmed=!0,jc.page.rm(params))});else Swal.fire({title:AS.label("Warning"),text:AS.label("CantDeleteIndex"),icon:"error"})},jc.page.save=params=>{if(params.mute||jc.progress(AS.label("SavingPage")),AS.test.udef(params)?params={}:AS.test.func(params)&&(params={callback:params}),AS.test.udef(params.data)&&(params.data=jc.edit.data()||jc.page.data().pageContent),AS.test.udef(params.page)&&(params.page=jc.page.current()),AS.test.udef(params.id)&&(params.id=params.data.id),AS.test.udef(params.typelist))jc.lists.list.get(params.page,l=>{params.typelist=l||{},jc.page.save(params)});else if(AS.test.udef(params.fulllist))jc.lists.list.get(l=>{params.fulllist=l||{},jc.page.save(params)});else{if("new"==params.id)if(params.isNew=!0,Object.keys(params.typelist).length){let max=0;Object.keys(params.typelist).forEach(n=>{n=parseInt(n);!isNaN(n)&&n>=max&&(max=n+1)}),0<max&&(params.id=max)}else params.id=1;if(params.tpd||(AS.test.udef(params.data.metadata)&&(params.data.metadata={}),Object.keys(params.data).forEach(k=>{AS.test.arr(params.data[k])&&params.data[k].forEach(i=>{AS.test.obj(i)&&!AS.test.arr(i)&&delete i._})}),params.id&&(params.data.id=params.id,params.data.metadata.id=params.id),!params.data.metadata.description&&AS.test.str(params.data.abstract)&&(params.data.metadata.description=params.data.abstract.dehtml().shorten(256)),!params.data.metadata.title&&AS.test.str(params.data.title)&&(params.data.metadata.title=params.data.title.dehtml().shorten(48)),params.tpd={title:params.data.metadata.title||"",desc:params.data.metadata.description||"",upd:(new Date).getTime(),user:jc.prop.authUser},params.data.metadata.hidden&&(params.tpd.hidden=!0),params.data.blogdate&&(params.tpd.date=params.data.blogdate),params.id&&(params.tpd.id=parseInt(params.id)),!params.tpd.title.length&&AS.test.str(params.data.title)&&(params.tpd.title=params.data.title.dehtml().shorten(48)),params.tpd.title.length||(params.tpd.title=params.page+(params.id?" "+params.id:""))),params.saved)return params.noFullList||params.savedFullList?params.noFullList||params.savedTypeList?params.noLasts||params.savedLasts?void(params.noLasts||params.savedDates?(params.mute||jc.progress(!1),params.isNew||params.noDialog||params.mute||window.setTimeout(()=>{Swal.fire({title:AS.label("PageSavedTitle"),text:AS.label("PageSavedBody",{page:params.page,id:params.id}),icon:"success",showCancelButton:!1,showConfirmButton:!1,timer:1500,timerProgressBar:!0})},100),AS.test.func(params.callback)?params.callback.call(window,params.page,params.id,params.data):(jc.edit&&jc.edit.data(!1),jc.page.current("-"),jc.page.open(params.page,params.id))):jc.page.makeTypeDates(params.page,params.typelist,()=>{params.savedDates=!0,jc.page.save(params)})):(params.mute||jc.progress(AS.label("SavingLasts")),void jc.page.makeLasts(params.fulllist,()=>{jc.page.makeTypeLasts(params.page,params.typelist,()=>{params.savedLasts=!0,jc.page.save(params)})})):(params.typelist[String(params.id||0)]=params.tpd,void jc.lists.list.set(params.page,params.typelist,()=>{params.savedTypeList=!0,jc.page.save(params)})):(AS.test.udef(params.fulllist[params.page])&&(params.fulllist[params.page]={}),params.fulllist[params.page][String(params.id||0)]=params.tpd,params.mute||jc.progress(AS.label("SavingArticleList")),void jc.lists.list.set(params.fulllist,()=>{params.savedFullList=!0,jc.page.save(params)}));jc.jdav.put(params.page+(params.id||"")+".json",params.data,()=>{params.saved=!0,jc.page.save(params)})}},jc.page.makeLasts=(list,callback)=>{if(AS.test.obj(list)){let lasts=[];Object.keys(list).forEach(t=>{let typelist=list[t];Object.keys(typelist).forEach(k=>{if(!typelist[k].hidden){let pm=Object.assign(typelist[k]);pm.page=t,lasts.push(pm)}})}),lasts.sort((a,b)=>b.upd-a.upd),qts=jc.prop.lastChangedQuantities.clone().map(i=>parseInt(i)).filter(i=>!isNaN(i)),qts.sort((a,b)=>b-a);let makeRss=!0,proc=()=>{var qt;qts.length?(qt=qts.shift(),lasts.splice(qt-1),makeRss?(makeRss=!1,qts.unshift(qt),jc.lists.last.dorss("site",qt,lasts,proc)):jc.lists.last.set(qt,lasts,proc)):AS.test.func(callback)&&callback.call(window)};proc()}else jc.lists.list.get(l=>{jc.page.makeLasts(l||{},callback)})},jc.page.makeTypeLasts=(pagetype,typelist,callback)=>{if(AS.test.obj(typelist)){let lasts=[];Object.keys(typelist).forEach(k=>{if(!typelist[k].hidden){let pm=Object.assign(typelist[k]);delete pm.page,lasts.push(pm)}}),lasts.sort((a,b)=>b.upd-a.upd),qts=jc.prop.lastChangedQuantities.clone().map(i=>parseInt(i)).filter(i=>!isNaN(i)),qts.sort((a,b)=>b-a);let proc=()=>{var qt;qts.length?(qt=qts.shift(),lasts.splice(qt-1),jc.lists.last.set(pagetype,qt,lasts,proc)):AS.test.func(callback)&&callback.call(window)};proc()}else jc.lists.list.get(pagetype,l=>{typelist=l||{},jc.page.makeTypeLasts(pagetype,typelist,callback)})},jc.page.makeTypeDates=(pagetype,typelist,callback)=>{if(AS.test.obj(typelist)){let aggr={};Object.keys(typelist).forEach(dp=>{const pm=typelist[dp];pm.hidden||!AS.test.str(pm.date)||3==(dp=pm.date.split("-")).length&&(aggr[dp[0]]=AS.def.arr(aggr[dp[0]]),aggr[dp[0]].push(pm),aggr[dp[0]+"-"+dp[1]]=AS.def.arr(aggr[dp[0]+"-"+dp[1]]),aggr[dp[0]+"-"+dp[1]].push(pm))});let flist=Object.keys(aggr).map(sel=>{let mlist=aggr[sel];return mlist.sort((a,b)=>a.date==b.date?a.upd<b.ud?-1:1:a.date<b.date?-1:1),{prefix:sel,list:mlist}}),purged=!1,indexes={byyear:{},bymonth:{}},proc=()=>{if(purged)if(flist.length){var f=flist.shift();4==f.prefix.length?(AS.test.udef(indexes.byyear[f.prefix])&&(indexes.byyear[f.prefix]=0),indexes.byyear[f.prefix]+=f.list.length):(AS.test.udef(indexes.bymonth[f.prefix])&&(indexes.bymonth[f.prefix]=0),indexes.bymonth[f.prefix]+=f.list.length),jc.jdav.put("struct/"+pagetype+"-bydate-"+f.prefix+".json",f.list,proc)}else{let ylist=[];Object.keys(indexes.byyear).forEach(k=>{ylist.push(k)}),ylist.sort().reverse(),indexes.byyear=ylist.map(k=>({key:k,file:"struct/"+pagetype+"-bydate-"+k+".json",qt:indexes.byyear[k]}));let mlist=[];Object.keys(indexes.bymonth).forEach(k=>{mlist.push(k)}),mlist.sort().reverse(),indexes.bymonth=mlist.map(k=>({key:k,file:"struct/"+pagetype+"-bydate-"+k+".json",qt:indexes.bymonth[k]})),jc.jdav.put("struct/"+pagetype+"-bydate-index.json",indexes,()=>{AS.test.func(callback)&&callback.call(window)})}else jc.dav.purge({dir:"struct",match:pagetype+"-bydate-",ext:"json"},()=>{purged=!0,proc()})};proc()}else jc.lists.list.get(pagetype,l=>{typelist=l||{},jc.page.makeTypeDates(pagetype,typelist,callback)})},jc.page.upload=(fld,...args)=>{let options={},callback;args.forEach(a=>{AS.test.func(a)?callback=a:AS.test.obj(a)&&(options=a)});const page=jc.page.current();let pdata=jc.page.data().pageContent;const id=pdata.id,prefix=page+(id||"");let uploads=AS.def.arr(pdata.uploads),news=[],indexes=[];for(let i=0;i<fld.files.length;i++)fld.files[i].size&&fld.files[i].size<jc.prop.maxUploadSize&&indexes.push(i);if(0==indexes.length)return fld.value="",void(AS.test.func(callback)&&callback.call(window,[],uploads));const process=()=>{let tf=fld.files[indexes.shift()],oname=tf.name;options.mute||jc.progress(oname);let ext=oname.replace(/.*\.([^.]+)$/,"$1").toLowerCase();var newname=AS.generateId(prefix)+"."+ext;let url=AS.path("jsdataroot")+"uploads/"+newname;tf.arrayBuffer().then(binary=>{binary=new DataView(binary);jc.dav.put(url,binary,sortf=>{if(sortf){let no={name:oname,ext:ext,uri:url,size:tf.size,type:tf.type,added:(new Date).getTime()};no.type&&no.type.length?(no.type.match(/^image\//)&&(no.img=!0),(no.img||no.type.match(/\/pdf$/))&&(no.fb=!0)):no.type="application/octet-stream",no.caption=options.caption||no.name.replace(/^(.*)\.[^.]+$/,"$1").replace(/[._ -]+/g," ").trim(),uploads.push(no),news.push(no)}if(indexes.length)process();else{sortf=(a,b)=>a.name.toLowerCase()<b.name.toLowerCase()?-1:1;uploads.sort(sortf),news.sort(sortf),fld.value="",pdata.uploads=uploads;let params={data:pdata,page:page,noLasts:!0,noFullList:!0,noDialog:!0,mute:!!options.mute,callback:()=>{options.mute||jc.progress(),AS.test.func(callback)&&callback.call(window,news,uploads)}};AS.test.def(id)&&(params.id=id),jc.page.save(params)}})})};process()},jc.page.rmUpload=(item,callback)=>{let recurse=n=>{if(AS.test.arr(n)){if(n.length)return n[0].uri?n.filter(i=>i.uri!=item.uri):n.map(i=>recurse(i))}else AS.test.obj(n)&&Object.keys(n).forEach(k=>{n[k]=recurse(n[k])});return n},pdata=recurse(jc.page.data().pageContent);jc.page.save({data:pdata,page:jc.page.current(),id:jc.page.data().pageContent.id,noLasts:!0,noFullList:!0,noDialog:!0,callback:()=>{jc.dav.rm(item.uri,()=>{jc.progress(),AS.test.func(callback)&&callback.call(window,pdata)})}})},jc.edit={prop:{blockTypes:[{type:"text",label:"TextOrHtml",menu:!0},{type:"gallery",label:"Gallery",menu:!0},{type:"audio",label:"Audio"},{type:"lasts",label:"LastChangedPages"},{type:"subpage",label:"IncludePage"},{type:"part",label:"IncludePagePart"}],formPlugins:["basic","pikaday","tinymce","iro","slider"],repo:{}},onload:()=>{AS.addEvent(document,"as:tinyMceInited",e=>{e.detail.getWrap().querySelector(".tox-tinymce").style.height=String(Math.min(Math.max(parseInt(window.innerHeight)-240,300),640))+"px"}),jc.edit.loadFormPlugins(),jc.edit.getRepository(),jc.edit.loadPageTypes(),jc.edit.loadPageParts()},loadFormPlugins:()=>{AS.form&&AS.form.plugin?(jc.edit.prop.formPlugins.forEach(p=>{AS.form.plugin(p)}),jc.springLoad(AS.path("jscdn")+"libs/as-form-jcplugins"+(jc.prop.isDeveloper?"":".min")+".js")):window.setTimeout(jc.edit.loadFormPlugins,100)},getRepository:(pagetype,callback)=>{if(AS.test.udef(pagetype)&&(pagetype=jc.page.current()),jc.edit.prop.repo[pagetype]||(jc.springLoad(AS.path("jsreporoot")+"/"+pagetype+".js"),jc.edit.prop.repo[pagetype]="_loading_"),"_loading_"!=jc.edit.prop.repo[pagetype])return AS.test.func(callback)?void callback.call(window,jc.edit.prop.repo[pagetype]):jc.edit.prop.repo[pagetype];setTimeout(()=>{jc.edit.getRepository(pagetype,callback)},100)},setRepository:(pagetype,data)=>jc.edit.prop.repo[pagetype]=data,loadPageTypes:force=>{!force&&jc.edit.prop.pageTypes||(jc.edit.prop.pageTypes=!0,jc.jdav.get(AS.path("jsauth")+"auth/lstemplates",r=>{jc.edit.prop.pageTypes=r.list}))},loadPageParts:force=>{!force&&jc.edit.prop.pageParts||(jc.edit.prop.pageParts=!0,jc.jdav.get(AS.path("jsauth")+"auth/lsparts",r=>{jc.edit.prop.pageParts=r.list}))},start:()=>{document.querySelectorAll(".jcEditable:not(.jcEditableParsed)").forEach(data=>{let $d=$(data);data=$d.data("editable");if(data||!AS.test.obj(data)){$d.addClass("jcEditableParsed");let $em=$('<div class="jcEditMenu"></div>');"page"==jc.page.prop.editMode?(AS.test.def(data._)&&AS.test.def(data._.idx)?($d.on("dblclick",jc.edit.edit),data._.idx<data._.qt-1&&$em.append('<span class="jcEditMoveDown" onclick="jc.edit.movedown(event)">'+AS.icon("moveDown")+"</span>"),data._.idx&&$em.append('<span class="jcEditMoveUp" onclick="jc.edit.moveup(event)">'+AS.icon("moveUp")+"</span>"),$em.append('<span class="jcEditDropdown">'+AS.icon("menu")+"</span>")):"mixed"==data.subtype?$em.append('<span class="jcEditDropdown">'+AS.icon("editAdd")+"</span>"):($d.on("dblclick",jc.edit.edit),$em.append('<span class="jcEditDropdown">'+AS.icon("edit")+"</span>")),$d.prepend($em),$d.on("contextmenu",jc.edit.menu),$(".jcEditMenu .jcEditDropdown",$d).on("click contextmenu",jc.edit.menu)):"parts"==jc.page.prop.editMode&&($d.on("dblclick",jc.edit.part),$em.append('<span class="jcEditDropdown">'+AS.icon("edit")+"</span>"),$d.prepend($em),$d.on("contextmenu",jc.edit.part),$(".jcEditMenu .jcEditDropdown",$d).on("click contextmenu",jc.edit.part))}else $d.removeClass("jcEditable")})},data:d=>{if(0==d)jc.prefs.purge("onEditData");else{if(AS.test.obj(d))return jc.prefs.key("onEditData",{page:jc.page.current(),id:jc.page.data().id,data:d}),jc.prefs.key("onEditData").data;if("page"==jc.page.prop.editMode){let theSame=(d=jc.prefs.key("onEditData"))&&d.page==jc.page.current();if(theSame&&d.id&&(theSame=d.id==jc.page.data().id),theSame)return d.data;jc.prefs.purge("onEditData")}}},menu:e=>{var data=jc.edit.itemdata(e);let hl=".jcEditable",acts=[{icon:"jcicon",iconKey:"edit",label:AS.label("blockEditContent"),action:jc.edit.edit}];if(data.subtype){let canAdd=AS.test.def(data._)&&AS.test.def(data._.idx);if("mixed"==data.subtype?(hl=!1,canAdd=!0,acts.shift()):canAdd&&("subpage"==data.subtype&&acts.push("-",{icon:"jcicon",iconKey:"editGo",label:AS.label("GotoPage"),action:jc.edit.gotoSubpage}),acts.push("-",{icon:"jcicon danger",iconKey:"editRemove",label:AS.label("blockDeleteContent"),action:jc.edit.rm},"-")),canAdd){let addItem={icon:"jcicon",iconKey:"editAdd",ricon:"jcicon",riconKey:"arrow-down",label:AS.label("blockAddContent"),action:jc.edit.add};if(1<jc.edit.prop.blockTypes.length){addItem.label+="…";let vt=jc.edit.prop.blockTypes.filter(t=>t.menu);vt.length&&(addItem.content=vt.map(t=>({label:AS.label(t.label),action:e=>{jc.edit.add(e,t.type)}})))}acts.push(addItem)}}if(acts.length){if(1==acts.length)return acts[0].action.call(window,e);acts.unshift("Block: "+(data.subtype||data.type)),jc.menu(e,{content:acts,highlight:hl})}},itemdata:e=>(e.preventDefault(),e.stopPropagation(),$(e.target).closest(".jcEditable").data("editable")),gotoSubpage:b=>{b=jc.edit.itemdata(b);let p=jc.edit.data()[b.prop];AS.test.arr(p)&&AS.test.def(b._.idx)&&(p=p[b._.idx][b.subtype]),AS.test.obj(p)&&jc.page.open(p.page,p.id)},moveup:b=>{b=jc.edit.itemdata(b);let d=jc.edit.data();Array.isArray(d[b.prop])&&(d[b.prop].splice(b._.idx-1,2,d[b.prop][b._.idx],d[b.prop][b._.idx-1]),jc.edit.fixBlocks(b,d),jc.page.reload())},movedown:b=>{b=jc.edit.itemdata(b);let d=jc.edit.data();Array.isArray(d[b.prop])&&(d[b.prop].splice(b._.idx,2,d[b.prop][b._.idx+1],d[b.prop][b._.idx]),jc.edit.fixBlocks(b,d),jc.page.reload())},edit:e=>{let b=jc.edit.itemdata(e),d=jc.edit.data(),t=b.subtype||b.type;if(jc.edit.custom[t])jc.edit.custom[t].edit(b,d);else if(jc.edit.form[t]){let $mod=jc.edit.getModal(!0);$mod.on("shown.bs.modal",()=>{AS.form.create(jc.edit.form[t].call(window,b,d))}),$mod.modal("show")}},form:{_base:(b,d)=>{var $mod=jc.edit.getModal();let t=b.subtype||b.type;return $(".modal-dialog",$mod).append(`<div class="modal-content">
				<div class="modal-header bg-light">
					<p class="modal-title">
						<span class="jcicon">${AS.icon("edit")}</span> 
						<b>
							${AS.label("Edit")} “${jc.page.current()}”${jc.page.data().id?" ID: "+jc.page.data().id:""},
							${b.prop}${AS.test.def(b._)&&AS.test.def(b._.qt)?" ["+(AS.test.num(b._.idx)?String(b._.idx+1)+"/"+b._.qt:b._.idx)+"]":""}
						</b>
					</p>
					<button type="button" class="close" onclick="jc.edit.noModal()" aria-label="Close">
						<span aria-hidden="true" class="jcicon modalCloser">${AS.icon("circleClose")}</span>
					</button>
				</div>
				<div class="modal-body" id="jcPageEditor"></div>
			</div>`),{options:{effectduration:0,theme:"transparent",subforms:[],jsaction:(fd,fo)=>{fo.destroy(),jc.edit.noModal(),AS.test.def(b._)&&AS.test.def(b._.qt)?(d[b.prop][b._.idx]=fd,jc.edit.fixBlocks(b,d)):AS.test.def(fd[t])?(d[b.prop]=fd[t],jc.edit.data(d)):d[b.prop]=fd,jc.page.reload()}},fields:[["btns","buttons",{position:"bottom",list:[{label:AS.label("Cancel"),icon:AS.icon("circleClose"),onclick:jc.edit.noModal},{btype:"reset"},{btype:"submit"}]}]],target:"jcPageEditor",callback:f=>{b._&&b._.qt?f.parse(d[b.prop][b._.idx]):AS.test.def(d[b.prop])&&f.setValue(t,d[b.prop])}}},lasts:(b,vtypes)=>{let o=jc.edit.form._base(b,vtypes),ptypes=jc.edit.prop.pageTypes.clone();ptypes.unshift({label:AS.label("Choose"),value:""},{label:"* "+AS.label("All"),value:"_all"});vtypes=[{label:AS.label("Numbered list"),value:"ol,li"},{label:AS.label("Bullet list"),value:"ul,li"},{label:AS.label("Plain list"),value:"div,div"}];return o.fields.push(["type","hidden",{value:"lasts"}],["ptype","select",{asLabel:"PageType",options:ptypes,skipempty:!0,mandatory:!0}],["title","text",{asLabel:"Title",normalize:!0,skipempty:!0,depends:"ptype"}],["view","select",{asLabel:"blockTextAspect",options:vtypes,depends:"ptype"}],["max","slider",{asLabel:"Max",min:1,max:100,report:{value:!0},default:10,depends:"ptype"}],["showdate","bool",{asLabel:"ShowDate",depends:"ptype"}],["showtime","bool",{asLabel:"ShowTime",depends:"showdate"}],["showdesc","bool",{asLabel:"ShowDesc",depends:"ptype"}]),o},date:(b,d)=>{let o=jc.edit.form._base(b,d);return o.fields.push(["date","date",{asLabel:"Date",skypempty:!0,asTitle:"onlyNonEmptyFields",format:"YYYY-MM-DD",default:(new Date).tosqldate()}],["footer","freehtml",{value:"<br />"}]),o},part:(b,d)=>{let o=jc.edit.form._base(b,d),opts=jc.edit.prop.pageParts.clone();return opts.sort(),opts.unshift({label:AS.label("Choose")+"…",value:""}),o.fields.push(["part","select",{asLabel:"PageType",options:opts,mandatory:!0}],["type","hidden",{value:"part"}],["footer","freehtml",{value:"<br />"}]),o},text:(b,d)=>{let o=jc.edit.form._base(b,d);return b._&&AS.test.def(b._.qt)?o.fields.push(["type","select",{asLabel:"blockType",default:"text",options:[{label:AS.label("HTML"),value:"html"},{label:AS.label("Text"),value:"text"}],onchange:(x,fo)=>{let f=fo.getForm();["text","html"].forEach(fn=>{f.fieldByName(fn).disable(),f.fieldByName(fn).hide()});let rf=f.fieldByName(x);rf.setValue(rf.realField&&rf.realField()?rf.realField().value:""),rf.enable(),rf.show()}}],["html","html",{nolabel:!0,trim:!0,asTitle:"onlyNonEmptyFields",value:""}],["wrap","select",{asLabel:"blockTextAspect",default:"<h4></h4>",options:[{label:AS.label("H3"),value:"<h3></h3>"},{label:AS.label("H4"),value:"<h4></h4>"},{label:AS.label("Text"),value:"<div></div>"},{label:AS.label("Note (warning)"),value:'<div class="alert alert-warning" role="alert" style="width:66%;margin-left:auto;"></div>'}],depends:"type=text"}],["text","textarea",{nolabel:!0,trim:!0,asTitle:"onlyNonEmptyFields",value:""}]):o.fields.push(["text","textarea",{nolabel:!0,trim:!0,asTitle:"onlyNonEmptyFields",value:""}]),o},html:(b,d)=>{let o=jc.edit.form._base(b,d);return o.fields.push(["type","select",{asLabel:"blockType",default:"html",options:[{label:AS.label("HTML"),value:"html"},{label:AS.label("Text"),value:"text"}],onchange:(x,fo)=>{let f=fo.getForm();["text","html"].forEach(fn=>{f.fieldByName(fn).disable(),f.fieldByName(fn).hide()});let rf=f.fieldByName(x);rf.setValue(rf.realField&&rf.realField()?rf.realField().value:""),rf.enable(),rf.show()}}],["html","html",{nolabel:!0,trim:!0,asTitle:"onlyNonEmptyFields",value:""}],["wrap","select",{asLabel:"blockTextAspect",default:"<h4></h4>",options:[{label:AS.label("H3"),value:"<h3></h3>"},{label:AS.label("H4"),value:"<h4></h4>"},{label:AS.label("Text"),value:"<div></div>"}],depends:"type=text"}],["text","textarea",{nolabel:!0,trim:!0,asTitle:"onlyNonEmptyFields",value:""}]),o},subpage:(b,d)=>{let o=jc.edit.form._base(b,d);return o.fields.push(["title","freehtml",{value:"<h5>"+AS.label("BlocksFromPage")+"</h5>"}],["type","hidden",{value:"subpage"}],["subpage","jcpage",{nolabel:!0,skypempty:!0,mandatory:!0}],["force","bool",{asLabel:"ForceAlsoHidden",depends:"subpage"}],["footer","freehtml",{value:"<br />"}]),o}},add:(e,t)=>{let ob=jc.edit.itemdata(e),d=jc.edit.data();if(1==jc.edit.prop.blockTypes.length&&(t=jc.edit.prop.blockTypes[0]),AS.test.str(t))jc.edit.addType(ob,d,t);else{let ml=AS.label("Mains")+":",ol=AS.label("Others")+":",opts={};opts[ml]={},jc.edit.prop.blockTypes.filter(t=>t.menu).forEach(t=>{opts[ml][t.type]=AS.label(t.label)}),opts[ol]={},jc.edit.prop.blockTypes.filter(t=>!t.menu).forEach(t=>{opts[ol][t.type]=AS.label(t.label)}),Swal.fire({title:AS.label("SelectBlockType"),text:AS.label("SelectBlockTypeDesc"),input:"select",icon:"question",inputOptions:opts,inputPlaceholder:AS.label("Choose")+"…",showCancelButton:!0,cancelButtonText:AS.label("Cancel"),confirmButtonText:AS.label("OK"),inputValidator:v=>new Promise(resolve=>{v.length?resolve():resolve(AS.label("SelectBlockType"))})}).then(result=>{result.isConfirmed&&jc.edit.addType(ob,d,result.value)})}},addType:(b,d,t)=>{jc.edit.custom[t]?jc.edit.custom[t].add(b,d):jc.edit.addByForm(b,d,t)},addByForm:(b,d,t)=>{let nb={prop:b.prop,_:{idx:AS.label("New")}};!b._||AS.test.udef(b._.qt)?nb._.qt=0:nb._.qt=b._.qt;let $mod=jc.edit.getModal(!0),fopt=jc.edit.form[t].call(window,nb,d);fopt.options.jsaction=(fd,fo)=>{fo.destroy(),jc.edit.noModal(),b._&&AS.test.def(b._.qt)?d[b.prop].splice(b._.idx,1,d[b.prop][b._.idx],fd):(AS.test.arr(d[b.prop])||(d[b.prop]=[]),d[b.prop].push(fd)),jc.edit.fixBlocks(b,d),jc.page.reload()},fopt.callback=f=>{AS.test.def(t)?f.setValue("type",t):b._||AS.test.udef(b._.qt)?f.setValue("type","html"):f.setValue("type",d[b.prop][b._.idx].type)},$mod.on("shown.bs.modal",()=>{AS.form.create(fopt)}).modal("show")},fixBlocks:(b,d)=>{let qt=d[b.prop].length;d[b.prop].forEach((x,i)=>{x._||(x._={}),x._.idx=i,x._.qt=qt}),jc.edit.data(d)},rm:b=>{b=jc.edit.itemdata(b);let d=jc.edit.data();Array.isArray(d[b.prop])&&(d[b.prop].splice(b._.idx,1),jc.edit.data(d),jc.page.reload())},part:e=>{let b=jc.edit.itemdata(e);b.target=e.target,b.type=AS.test.obj(b.raw)?"object":"html",jc.edit.partEdit(b)},partEdit:data=>{if("object"==data.type&&AS.test.udef(data.repo))jc.template.part.get(data.src,{repo:!0},repo=>{data.repo=repo,jc.edit.partEdit(data)});else{let $mod=jc.edit.getModal(!0);$(".modal-dialog",$mod).append(`<div class="modal-content">
				<div class="modal-header bg-light">
					<p class="modal-title">
						<span class="jcicon">${AS.icon("edit")}</span> 
						<b> ${AS.label("Edit")} “${data.src}” </b>
					</p>
					<button type="button" class="close" onclick="jc.edit.noModal()" aria-label="Close">
						<span aria-hidden="true" class="jcicon modalCloser">${AS.icon("circleClose")}</span>
					</button>
				</div>
				<div class="modal-body" id="jcPageEditor"></div>
			</div>`);let fo;"object"==data.type?(fo=data.repo.form(),fo.callback=f=>{f.parse(data.raw)},fo.options.jsaction=(fd,f)=>{f.destroy(),jc.edit.noModal(),jc.template.part.put(data.src,fd,()=>{jc.page.reload()})}):fo={options:{theme:"transparent",subforms:[],jsaction:(fd,f)=>{f.destroy(),jc.edit.noModal(),jc.template.part.put(data.src,fd.html,()=>{jc.page.reload()})}},fields:[["html","html",{nolabel:!0,trim:!0,asTitle:"onlyNonEmptyFields",value:""}]],callback:f=>{f.setValue("html",data.raw)}},fo.target="jcPageEditor",fo.options.effectduration=0,fo.fields.push(["hr","hr",{position:"bottom"}],["btns","buttons",{position:"bottom",list:[{label:AS.label("Cancel"),icon:AS.icon("circleClose"),onclick:jc.edit.noModal},{btype:"submit"}]}]),$mod.on("shown.bs.modal",()=>{AS.form.create(fo)}),$mod.modal("show")}},getModal:buildNew=>{if(buildNew){let f;for(;f=AS.form.getForm();)f.destroy();$("#jcEditModalLg").remove()}let mod=$("#jcEditModalLg");return 0==mod.length&&(mod=$('<div id="jcEditModalLg" class="modal" tabindex="-1"><div class="modal-dialog modal-lg"></div></div>'),$(document.body).append(mod)),mod},noModal:()=>{jc.edit.getModal().modal("hide").remove()}},jc.edit.meta={edit:options=>{var pagetype=(options=AS.def.obj(options)).pagetype||jc.page.current(),pd=options.pageData||jc.page.data();let ed=options.editData||jc.edit.data();if(options.form){AS.test.udef(ed.metadata)&&(ed.metadata={type:jc.page.current(),id:pd.id});let $mod=jc.edit.getModal(!0);$(".modal-dialog",$mod).append(`<div class="modal-content">
			<div class="modal-header bg-info text-white">
				<p class="modal-title">
					<span class="jcicon">${AS.icon("metadata")}</span> 
					<b>${AS.label("Properties")}</b>
				</p>
				<button type="button" class="close" onclick="jc.edit.noModal()" aria-label="Close">
					<span aria-hidden="true" class="jcicon modalCloser">${AS.icon("circleClose")}</span>
				</button>
			</div>
			<div class="modal-body" id="jcPageEditor"></div></div>`),options.form.callback=f=>{ed.metadata&&f.parse(ed.metadata)},options.form.target="jcPageEditor",options.form.options.effectduration=0,options.form.options.theme="light",options.form.options.title=`“${ed.metadata.type}”${ed.metadata.id?" ID: "+ed.metadata.id:""}`,options.form.fields.push(["btns","buttons",{position:"bottom",list:[{label:AS.label("Cancel"),icon:AS.icon("circleClose"),onclick:"()=>{jc.edit.noModal();}"},{btype:"reset"},{btype:"submit",asLabel:"Done"}]}]),options.form.options.jsaction=(fd,f)=>{f.destroy(),jc.edit.noModal(),ed.metadata=fd,options.callback?options.callback.call(window,ed):jc.edit.data(ed)},$mod.on("shown.bs.modal",()=>{AS.form.create(options.form)}).modal("show")}else jc.edit.getRepository(pagetype,repo=>{repo&&repo.form&&repo.form.metadata?(options.form=JSON.parse(JSON.stringify(repo.form.metadata)),jc.edit.meta.edit(options)):jc.edit.getRepository("index",repo=>{options.form=JSON.parse(JSON.stringify(repo.form.metadata)),jc.edit.meta.edit(options)})})}},jc.edit.custom={audio:{getModal:empty=>{var $mod=jc.edit.getModal(empty);return empty&&$(".modal-dialog",$mod).append(`<div class="modal-content">
					<div class="modal-header bg-info text-white">
						<p class="modal-title">
							<span class="jcicon">${AS.icon("audio")}</span> 
							<b>${AS.label("Audio")}</b>
						</p>
						<button type="button" class="close" onclick="jc.edit.noModal()" aria-label="Close">
							<span aria-hidden="true" class="jcicon modalCloser">${AS.icon("circleClose")}</span>
						</button>
					</div>
					<div class="modal-body" id="jcPageAudio"></div></div>`),$mod},add:(b,d)=>{var canRecord=!!window.MediaRecorder;let $mod=jc.edit.custom.audio.getModal(!0);if(canRecord){let blob,mediaRecorder;const $audio=$("<audio controls>Your browser doesn’t support audio</audio>"),$bt=$('<button type="button" class="btn btn-primary jcAudioToggler"><span class="jcicon">'+AS.icon("mic")+"</span></button>"),$btp=$('<button type="button" class="btn btn-secondary jcAudioPauser" style="display:none;"><span class="jcicon">'+AS.icon("pause")+"</span></button>"),$hflex=$('<hflex class="wrap"></hflex>');$hflex.append($audio,$bt,$btp),$(".modal-body",$mod).append($hflex);$bt.on("click",()=>{mediaRecorder?mediaRecorder.stop():(async()=>{let chunks=[];const doBlob=()=>blob=chunks.length?new Blob(chunks,{type:mediaRecorder.mimeType}):!1;let stream=await navigator.mediaDevices.getUserMedia({audio:!0});mediaRecorder=new MediaRecorder(stream),mediaRecorder.addEventListener("start",e=>{$bt.removeClass("btn-primary btn-danger"),$btp.removeClass("btn-secondary btn-warning"),$bt.addClass("btn-danger"),$("span",$bt).html(AS.icon("stop")),$btp.addClass("btn-secondary").show()}),mediaRecorder.addEventListener("dataavailable",e=>{e.data&&chunks.push(e.data)}),mediaRecorder.addEventListener("stop",e=>{$bt.removeClass("btn-primary btn-danger"),$btp.removeClass("btn-secondary btn-warning"),$bt.addClass("btn-primary"),$("span",$bt).html(AS.icon("mic")),$btp.hide(),stream.getTracks().forEach(track=>track.stop()),doBlob(),blob&&($audio.get(0).src=URL.createObjectURL(blob)),mediaRecorder=!1}),mediaRecorder.addEventListener("pause",e=>{$btp.removeClass("btn-secondary").addClass("btn-warning"),doBlob(),blob&&($audio.get(0).src=URL.createObjectURL(blob))}),mediaRecorder.addEventListener("resume",e=>{$btp.removeClass("btn-warning").addClass("btn-secondary")}),mediaRecorder.start(3e5)})()}),$btp.on("click",()=>{mediaRecorder&&("paused"==mediaRecorder.state?mediaRecorder.resume():mediaRecorder.pause())})}else $(".modal-body",$mod).append('<div class="alert alert-warning" role="alert">'+AS.label("BrowserMediaRecorderMissing")+"</div>");$mod.modal({show:!0,keyboard:!1})},edit:(b,d)=>{}},gallery:{getModal:empty=>{var $mod=jc.edit.getModal(empty);return empty&&$(".modal-dialog",$mod).append(`<div class="modal-content">
					<div class="modal-header bg-info text-white">
						<p class="modal-title">
							<span class="jcicon">${AS.icon("uploads")}</span> 
							<b>${AS.label("Attachments")}</b>
						</p>
						<button type="button" class="close" onclick="jc.edit.noModal()" aria-label="Close">
							<span aria-hidden="true" class="jcicon modalCloser">${AS.icon("circleClose")}</span>
						</button>
					</div>
					<div class="modal-body" id="jcPageUploads"></div></div>`),$mod},add:(b,d)=>{let nb={prop:b.prop,type:"block",subtype:"gallery",_:{idx:AS.label("New")}};var nd={type:"gallery",gallery:[]};b._&&AS.test.def(b._.qt)?d[b.prop].splice(b._.idx,1,d[b.prop][b._.idx],nd):(AS.test.arr(d[b.prop])||(d[b.prop]=[]),d[b.prop].push(nd)),jc.edit.fixBlocks(b,d),nb._.idx=nd._.idx,jc.edit.custom.gallery.edit(nb,d)},edit:(b,d)=>{AS.test.arr(d.uploads)||(d.uploads=[]);let bd=d[b.prop][b._.idx];AS.test.arr(bd.gallery)||(bd.gallery=[]);let $mod=jc.edit.custom.gallery.getModal(!0),params={target:$("#jcPageUploads",$mod),reloader:()=>{jc.edit.custom.gallery.edit(b,d)},select:!0,gallery:bd};$mod.on("shown.bs.modal",()=>{jc.edit.uploads.render(params)}).modal({show:!0,keyboard:!1})}}},jc.edit.uploads={edit:()=>{jc.page.data().pageContent;let $mod=jc.edit.getModal(!0);$(".modal-dialog",$mod).append(`<div class="modal-content">
			<div class="modal-header bg-info text-white">
				<p class="modal-title">
					<span class="jcicon">${AS.icon("uploads")}</span> 
					<b>${AS.label("Attachments")}</b>
				</p>
				<button type="button" class="close" onclick="jc.edit.noModal()" aria-label="Close">
					<span aria-hidden="true" class="jcicon modalCloser">${AS.icon("circleClose")}</span>
				</button>
			</div>
			<div class="modal-body" id="jcPageUploads"></div></div>`);let params={target:$("#jcPageUploads",$mod),reloader:()=>{jc.edit.uploads.edit()}};$mod.on("shown.bs.modal",()=>{jc.edit.uploads.render(params)}).modal({show:!0,keyboard:!1})},render:params=>{AS.test.func(params)&&(params={callback:params}),(params=AS.def.obj(params)).pageData||(params.pageData=jc.page.data().pageContent),params.uploads||(params.uploads=params.pageData.uploads),params.uploads=AS.def.arr(params.uploads),AS.test.def(params.gallery)&&!AS.test.obj(params.gallery)&&(params.gallery={}),params.gallery&&!AS.test.arr(params.gallery.gallery)&&(params.gallery.gallery=[]);let $out=$("<div></div>");$out.append($(`<div class="jcUploadsAdders text-center mb-4">
			<input type="file" multiple="multiple" style="display:none" />
			<span class="btn-group">
				<button type="button" class="btn btn-sm btn-primary jcImageUpload">${AS.icon("upload")} ${AS.label("Upload")}</button>
			</span>
		</div>`));let refresh=e=>{$(document.body).off("jc_page_data_loaded",refresh),params.reloader&&!params.thenClose&&params.reloader.call(window)};if(params.gallery){let $s=$('<select><option>S</option><option value="">M</option><option>L</option><option>XL</option></select>');$(".jcUploadsAdders .btn-group",$out).append($('<span class="ml-3 mt-1"></span>').append($s)),$s.val(params.gallery.size||""),$s.on("change",()=>{$s.val().length?params.gallery.size=$s.val():delete params.gallery.size,jc.page.save({noDialog:!0,noLasts:!0,callback:()=>{jc.edit.noModal(),$(document.body).on("jc_page_data_loaded",refresh),jc.page.reload()}})}),$s.select2({minimumResultsForSearch:1/0})}if($(".jcImageUpload",$out).on("click",()=>{$('input[type="file"]',$out).trigger("click")}),$('input[type="file"]',$out).on("change",e=>{(()=>{jc.edit.noModal();jc.page.upload($('input[type="file"]',$out).get(0),{},newitems=>{var finalize=()=>{$(document.body).on("jc_page_data_loaded",refresh),jc.page.reload()};params.gallery?(newitems.forEach(i=>{params.gallery.gallery.push({uri:i.uri})}),jc.page.save({noDialog:!0,noLasts:!0,callback:finalize})):finalize()})})()}),params.uploads.length){let $tbl=$('<table class="jcUploads"><thead><tr></tr></thead><tbody></tbody></table>');params.gallery&&$("thead tr",$tbl).append("<th></th>"),$("thead tr",$tbl).append(`<th>${AS.label("FileName")}</th><th>${AS.label("Caption")}</th><th>${AS.label("FileSize")}</th><th></th>`);let refresh=e=>{$(document.body).off("jc_page_data_loaded",refresh),params.reloader&&params.reloader.call(window)};let rm=item=>{(item instanceof Event||item.originalEvent)&&(item=$(item.target).closest("tr").data()),jc.page.rmUpload(item,newpdata=>{jc.edit.noModal(),$(document.body).on("jc_page_data_loaded",refresh),jc.page.reload()})},makeRow=u=>{let $tr=$('<tr class="jcUpload"></tr>');if($tr.data(u),params.gallery){let $i=$('<input type="checkbox" />');params.gallery.gallery.find(k=>k.uri==u.uri)&&$i.attr("checked",!0),$tr.append("<td></td>"),$("td",$tr).append($i)}u.fb?$tr.append(`<td class="fn"><a href="${u.uri}" data-fancybox="uploads" data-caption="${u.caption.escape()}">${u.name.escape()}</a></td>`):$tr.append('<td class="fn">'+u.name.escape()+"</td>");let $capt=$('<input type="text" name="caption" />');$capt.attr("value",u.caption),$tr.append($('<td class="fc"></td>').append($capt)),$tr.append('<td class="fs">'+parseInt(u.size).smartSize()+"</td>");var $acts=$('<td><span class="btn-group"></span></td>');$("span",$acts).append(`<a class="btn btn-primary btn-icon btn-sm legitRipple" title="${AS.label("Download")}" href="${u.uri}" download="${u.name.escape()}"><i>${AS.icon("download")}</i></a>`);let $del=$(`<a class="btn btn-danger btn-icon btn-sm legitRipple" title="${AS.label("Delete")}">${AS.icon("editRemove")}</a>`);$del.on("click",rm),$("span",$acts).append($del),$tr.append($acts),$("tbody",$tbl).append($tr)};params.gallery&&params.gallery.gallery.length?(params.gallery.gallery.forEach(s=>{var u=params.uploads.find(k=>k.uri==s.uri);u&&makeRow(u)}),params.uploads.forEach(u=>{params.gallery.gallery.find(k=>k.uri==u.uri)||makeRow(u)})):params.uploads.forEach(u=>{makeRow(u)}),$out.append($tbl),$out.append(`<div class="text-right"><a class="btn btn-primary saveUploads">${AS.label("Save")}</a></div>`),$('input[type="checkbox"]',$tbl).on("click change",e=>{e.stopPropagation(),params.gallery.gallery=[],$('tr.jcUpload input[type="checkbox"]:checked',$out).each((_idx,u)=>{u=$(u).closest("tr").data();params.gallery.gallery.push({uri:u.uri})}),AS.test.func(params.onchange)?params.onchange.call(params.gallery.gallery.clone()):jc.page.save({noDialog:!0,noLasts:!0,callback:()=>{jc.edit.noModal(),$(document.body).on("jc_page_data_loaded",refresh),jc.page.reload()}})}),$('input[name="caption"]',$tbl).on("change",()=>{let capts={};$("tr.jcUpload",$out).each((_idx,tr)=>{var data=$(tr).data();let $i=$('input[name="caption"]',tr);$i.val(capts[data.uri]=String($i.val()||"").replace(/[\\"]/g,"").trim())}),params.uploads.forEach(u=>{u.caption=capts[u.uri]}),jc.page.save({noDialog:!0,noLasts:!0,callback:()=>{}})}),$(".saveUploads",$out).on("click",()=>{params.thenClose=!0,jc.edit.noModal()})}else $out.append('<div class="jcPlaceHolder text-center">'+AS.label("NoItemsFound")+"</div>");return params.target&&$(params.target).append($out),AS.test.func(params.callback)&&params.callback.call(window,$out),$out}},jc.edit.loadPageTypes=force=>{!force&&jc.edit.prop.pageTypes||(jc.edit.prop.pageTypes=!0,jc.jdav.get(AS.path("jsauth")+"auth/lstemplates",r=>{jc.edit.prop.pageTypes=r.list}))},jc.edit.loadPageParts=force=>{!force&&jc.edit.prop.pageParts||(jc.edit.prop.pageParts=!0,jc.jdav.get(AS.path("jsauth")+"auth/lsparts",r=>{jc.edit.prop.pageParts=r.list}))},$(()=>{jc.edit.onload()});