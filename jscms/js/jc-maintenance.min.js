jc.maint={prop:{full:{}},start:()=>{jc.maint.proc({})},proc:params=>{if(!jc.maint.prop.uploads)return jc.progressbar({text:"Listing uploads…"}),void jc.jdav.ls({dir:"uploads"},x=>{jc.maint.prop.uploads={},jc.maint.prop.uploadsOrphans={},x.list.forEach(k=>{jc.maint.prop.uploads[k]=!0,jc.maint.prop.uploadsOrphans[k]=!0}),setTimeout(()=>{jc.maint.proc(params)},10)});if(jc.maint.prop.tags||(jc.maint.prop.tagnames=[],jc.maint.prop.tags={},AS.def.arr(jc.prop.site&&jc.prop.site.tags).forEach(x=>{jc.maint.prop.tagnames.push(x.name),jc.maint.prop.tags[x.name]={}})),!params.scanlist&&!params.tobescanned)return params.initial={page:jc.page.current(),id:jc.page.data().id},jc.progressbar({text:"Listing pages…"}),void jc.jdav.ls({dir:"pages"},x=>{params.tobescanned=x.list,params.totpages=x.list.length,setTimeout(()=>{jc.maint.proc(params)},10)});if(params.tobescanned){let isfirst=!1;params.scanlist||(params.scanlist=[],isfirst=!0);let nxt=params.tobescanned.shift();jc.progressbar({text:"Loading page…",prog:parseInt(10*(params.totpages-params.tobescanned.length)/params.totpages)/10}),params.scanlist.push(nxt),params.tobescanned.length||delete params.tobescanned;var page=nxt.replace(/^([^0-9.]+).*/,"$1"),k=nxt.match(/^[^0-9]+[0-9]+\..*$/)?parseInt(nxt.replace(/^[^0-9]+([0-9]+)\..*$/,"$1")):void 0;return console.log("Scanning:",page,k),void(isfirst&&page==params.initial.page&&k==params.initial.id?(params.tobescanned.push(params.scanlist.pop()),setTimeout(()=>{jc.maint.proc(params)},10)):jc.maint.scan(page,k,()=>{jc.maint.proc(params)}))}if(!params.listsPurged)return jc.progressbar({text:"Deleting old lists…",prog:0}),params.tbdLists?void(params.tbdLists.length?(jc.progressbar({prog:parseInt(10*(params.tbdCount-params.tbdLists.length)/params.tbdCount)/10}),jc.dav.rm("struct/"+params.tbdLists.shift(),()=>{setTimeout(()=>{jc.maint.proc(params)},10)})):(params.listsPurged=!0,delete params.tbdLists,delete params.tbdCount,setTimeout(()=>{jc.maint.proc(params)},10))):(jc.jdav.ls({dir:"struct",ext:"rss"},x=>{x.list.forEach(k=>{jc.dav.rm("struct/"+k,()=>{})})}),void jc.jdav.ls({dir:"struct"},x=>{params.tbdLists=x.list,params.tbdCount=params.tbdLists.length,setTimeout(()=>{jc.maint.proc(params)},10)}));if(!params.savedFullList)return jc.progressbar({text:"Saving full list…",prog:0}),void jc.lists.list.set(jc.maint.prop.full,()=>{jc.progressbar({prog:.3}),jc.page.makeLasts(jc.maint.prop.full,()=>{params.savedFullList=!0,setTimeout(()=>{jc.maint.proc(params)},10)})});if(params.savedTypeLists){if(!params.savedTagsLists)return params.tagnames||(params.tagnames=jc.maint.prop.tagnames.clone(),params.tagnamesCount=params.tagnames.length),void(params.tagnames.length?(k=params.tagnames.shift(),jc.progressbar({text:"Saving tags: "+k,prog:parseInt(10*(params.tagnamesCount-params.tagnames.length)/params.tagnamesCount)/10}),jc.lists.tag.set(k,jc.maint.prop.tags[k],()=>{setTimeout(()=>{jc.maint.proc(params)},10)})):(params.savedTagsLists=!0,delete params.tagnames,delete params.tagnamesCount,setTimeout(()=>{jc.maint.proc(params)},10)));jc.progressbar({close:!0}),setTimeout(()=>{jc.maint.prop={full:{}},jc.page.open(params.initial.page,params.initial.id)},10)}else if(params.ptypes||(params.ptypes=Object.keys(jc.maint.prop.full),params.ptypesCount=params.ptypes.length),params.ptypes.length){let k=params.ptypes.shift();jc.progressbar({text:"Saving type: "+k,prog:parseInt(10*(params.ptypesCount-params.ptypes.length)/params.ptypesCount)/10}),jc.lists.list.set(k,jc.maint.prop.full[k],()=>{jc.page.makeTypeLasts(k,jc.maint.prop.full[k],()=>{jc.page.makeTypeDates(k,jc.maint.prop.full[k],()=>{setTimeout(()=>{jc.maint.proc(params)},10)})})})}else params.savedTypeLists=!0,delete params.ptypes,delete params.ptypesCount,setTimeout(()=>{jc.maint.proc(params)},10)},scan:(page,id,cb)=>{jc.maint.prop.afterscancb=cb,$(document.body).on("jc_page_open_completed",jc.maint.doscan),setTimeout(()=>{jc.page.open(page,id)},10)},doscan:(event,edata)=>{$(document.body).off("jc_page_open_completed",jc.maint.doscan);var page=edata.page;edata.id;let pd=jc.page.data().pageContent,cb=jc.maint.prop.afterscancb;if(delete jc.maint.prop.afterscancb,pd&&pd.metadata){jc.progressbar({text:"Scan: "+pd.metadata.title});let nm=JSON.parse(JSON.stringify(pd.metadata||{}));pd.blogdate&&(nm.date=pd.blogdate),jc.maint.prop.full[page]||(jc.maint.prop.full[page]={}),jc.maint.prop.full[page][String(pd.id||0)]=nm;let pdtags=jc.objFindAll(pd,"type","tags").clone();jc.maint.prop.tagnames.forEach(tagname=>{jc.maint.prop.tags[tagname]=jc.page.parseTagsOne(pd,tagname,jc.maint.prop.tags[tagname],pdtags)}),jc.dav.rm(AS.path("jsdatastatics")+page+(pd.id||"")+".html",()=>{jc.page.makeStatic(cb)})}else{let id=pd&&AS.test.def(pd.id)?String(pd.id):"";console.log("Unknown metadata:",page,id,pd),jc.dav.rm(AS.path("jsdatastatics")+page+id+".html",cb)}}};